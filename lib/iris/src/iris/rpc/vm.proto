// Copyright 2025 The Marin Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

edition = "2023";

package iris.vm;

import "time.proto";
import "config.proto";

// VM lifecycle states
enum VmState {
  VM_STATE_UNSPECIFIED = 0;
  VM_STATE_BOOTING = 1;      // VM allocated, waiting for SSH
  VM_STATE_INITIALIZING = 2; // SSH available, running bootstrap
  VM_STATE_READY = 3;        // Worker registered with controller
  VM_STATE_UNHEALTHY = 4;    // Health check failed
  VM_STATE_STOPPING = 5;     // Termination requested
  VM_STATE_TERMINATED = 6;   // VM deleted
  VM_STATE_FAILED = 7;       // Boot or init failed
  VM_STATE_PREEMPTED = 8;    // Spot/preemptible VM reclaimed
  VM_STATE_REQUESTING = 9;   // GCP API call in progress
}

// Scaling action types
enum ScalingAction {
  SCALING_ACTION_UNSPECIFIED = 0;
  SCALING_ACTION_SCALE_UP = 1;
  SCALING_ACTION_SCALE_DOWN = 2;
  SCALING_ACTION_NONE = 3;
}

message ResourceSpec {
  int32 cpu = 1;
  int64 memory_bytes = 2;
  int64 disk_bytes = 3;
  int32 gpu_count = 4;
  int32 tpu_chips = 5;
}

// Information about a managed VM
message VmInfo {
  string vm_id = 1;
  string slice_id = 2;
  string scale_group = 3;
  VmState state = 4;
  string address = 5;
  string zone = 6;
  iris.time.Timestamp created_at = 7;
  iris.time.Timestamp state_changed_at = 8;

  // Worker info (populated after registration)
  string worker_id = 10;
  bool worker_healthy = 11;

  // Initialization tracking
  string init_phase = 20;
  string init_log_tail = 21;
  string init_error = 22;

  // Labels/metadata
  map<string, string> labels = 30;
}

// A TPU slice (atomic group of VMs)
message SliceInfo {
  string slice_id = 1;
  string scale_group = 2;
  iris.time.Timestamp created_at = 3;
  repeated VmInfo vms = 4;
}

// A scaling decision
message ScalingDecision {
  string scale_group = 1;
  ScalingAction action = 2;
  int32 slice_delta = 3;
  string reason = 4;
}

// Runtime state of a scale group (for status API)
message ScaleGroupStatus {
  string name = 1;
  iris.config.ScaleGroupConfig config = 2;

  // Current demand
  int32 current_demand = 20;
  int32 peak_demand = 21;

  // Backoff state
  iris.time.Timestamp backoff_until = 30;
  int32 consecutive_failures = 31;

  // Rate limiting
  iris.time.Timestamp last_scale_up = 40;
  iris.time.Timestamp last_scale_down = 41;

  // Slices in this group
  repeated SliceInfo slices = 50;
}

// Autoscaler action/event log entry
message AutoscalerAction {
  iris.time.Timestamp timestamp = 1;
  string action_type = 2;     // "scale_up", "scale_down", "quota_exceeded", "backoff_triggered", "worker_failed"
  string scale_group = 3;
  string slice_id = 4;        // Empty for group-level actions
  string reason = 5;
  string status = 6;          // "pending", "completed", "failed"
}

message DemandEntryStatus {
  repeated string task_ids = 1;
  string coschedule_group_id = 2;
  iris.config.AcceleratorType accelerator_type = 3;
  string accelerator_variant = 4;
  bool preemptible = 5;
  ResourceSpec resources = 6;
}

message UnmetDemand {
  DemandEntryStatus entry = 1;
  string reason = 2;
}

message RoutingDecision {
  map<string, int32> group_to_launch = 1;
  map<string, string> group_reasons = 2;
  map<string, DemandEntryStatusList> routed_entries = 3;
  repeated UnmetDemand unmet_entries = 4;
}

message DemandEntryStatusList {
  repeated DemandEntryStatus entries = 1;
}

// Full autoscaler status (for RPC response)
message AutoscalerStatus {
  repeated ScaleGroupStatus groups = 1;
  map<string, int32> current_demand = 2;
  iris.time.Timestamp last_evaluation = 3;
  repeated AutoscalerAction recent_actions = 4;  // Last N actions (max 100)
  RoutingDecision last_routing_decision = 5;
}
