// Copyright 2025 The Marin Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

edition = "2023";

package iris.config;

// ============================================================================
// PROVIDER CONFIGURATION
// ============================================================================

// Provider configuration for TPU scale groups
message TpuProvider {
  string project_id = 1;
}

// Provider configuration for manual (pre-existing hosts) scale groups
message ManualProvider {
  repeated string hosts = 1;
  string ssh_user = 2;           // Default: "root"
  string ssh_key_file = 3;
  int32 ssh_port = 4;            // Default: 22
}

// Per-scale-group provider configuration
message ProviderConfig {
  oneof provider {
    TpuProvider tpu = 1;
    ManualProvider manual = 2;
  }
}

// ============================================================================
// SCALE GROUP CONFIGURATION
// ============================================================================

// Device/accelerator type for scale groups
enum AcceleratorType {
  ACCELERATOR_TYPE_UNSPECIFIED = 0;
  ACCELERATOR_TYPE_CPU = 1;
  ACCELERATOR_TYPE_GPU = 2;
  ACCELERATOR_TYPE_TPU = 3;
}

// Configuration for a scale group
message ScaleGroupConfig {
  string name = 1;
  int32 min_slices = 2;
  int32 max_slices = 3;

  // Device configuration
  AcceleratorType accelerator_type = 9;  // Device type: cpu, gpu, or tpu
  string accelerator_variant = 10;       // Device variant: e.g., "v5litepod-16", "A100"
  string runtime_version = 11;
  bool preemptible = 12;

  // Zones to use (in priority order)
  repeated string zones = 20;

  // Priority for waterfall routing (lower = higher priority, default 100)
  int32 priority = 30;

  // Per-group provider configuration
  ProviderConfig provider = 90;
}

// ============================================================================
// BOOTSTRAP, TIMEOUT, AND SSH CONFIGURATION
// ============================================================================

// Bootstrap configuration passed to VmBootstrap
message BootstrapConfig {
  string controller_address = 1;  // Address workers use to connect (e.g., "10.0.0.1:10000")
  string worker_id = 2;           // Auto-generated if empty
  int32 worker_port = 3;          // Default: 10001
  string docker_image = 4;        // Worker image to run
  string cache_dir = 5;           // Default: /var/cache/iris
  map<string, string> env_vars = 6;
}

// Timeout configuration for VM lifecycle (SSH timeout is in SshConfig)
message TimeoutConfig {
  int32 boot_timeout_seconds = 1;        // Default: 300 (5 min)
  int32 init_timeout_seconds = 2;        // Default: 600 (10 min)
  reserved 3;                            // Was: ssh_connect_timeout_seconds (moved to SshConfig)
  int32 ssh_poll_interval_seconds = 4;   // Default: 5
}

// SSH configuration for manual hosts
message SshConfig {
  string user = 1;            // Default: "root"
  string key_file = 2;        // Path to SSH private key
  int32 port = 3;             // Default: 22
  int32 connect_timeout = 4;  // Default: 30
}

// ============================================================================
// CONTROLLER CONFIGURATION
// ============================================================================

// GCP-managed controller configuration
message GcpControllerConfig {
  string machine_type = 2;      // Default: "n2-standard-4"
  int32 boot_disk_size_gb = 3;  // Default: 50
  int32 port = 4;               // Default: 10000
}

// Manually-managed controller configuration (SSH bootstrap)
message ManualControllerConfig {
  string host = 1;
  int32 port = 3;               // Default: 10000
}

// Controller configuration using oneof for type-safe dispatch
message ControllerVmConfig {
  string image = 10;            // Controller docker image (shared by all controller types)
  oneof controller {
    GcpControllerConfig gcp = 1;
    ManualControllerConfig manual = 2;
  }
}

// ============================================================================
// ROOT CLUSTER CONFIGURATION
// ============================================================================

// Full cluster configuration - single source of truth
message IrisClusterConfig {
  // Provider settings
  string provider_type = 1;     // "tpu" or "manual"
  string project_id = 2;
  string region = 3;
  string zone = 4;

  // Controller settings
  ControllerVmConfig controller_vm = 31;

  reserved 40;  // Was: manual_hosts (now specified per-group in provider.manual.hosts)

  // Scale groups (name -> config)
  map<string, ScaleGroupConfig> scale_groups = 50;

  // GCP label prefix
  string label_prefix = 70;     // Default: "iris"

  // Nested configuration
  BootstrapConfig bootstrap = 80;
  TimeoutConfig timeouts = 81;
  SshConfig ssh = 82;
}
