// Copyright 2025 The Marin Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

edition = "2023";

package iris.config;

import "time.proto";

// Enable explicit presence tracking for all fields to support HasField on scalars
option features.field_presence = EXPLICIT;

// ============================================================================
// PLATFORM CONFIGURATION
// ============================================================================

message GcpPlatformConfig {
  string project_id = 1;
  repeated string zones = 5;  // All zones this platform operates in (for list_all_slices)
}

message ManualPlatformConfig {}

message LocalPlatformConfig {}

message CoreweavePlatformConfig {
  string region = 1;
  string namespace = 2;         // default: "iris"
  string kubeconfig_path = 3;   // optional, uses in-cluster auth if empty
  string object_storage_endpoint = 4;  // S3 base endpoint, NOT bucket-specific (e.g. https://cwobject.com)
}

message PlatformConfig {
  string label_prefix = 10;  // Default: "iris"
  oneof platform {
    GcpPlatformConfig gcp = 1;
    ManualPlatformConfig manual = 2;
    LocalPlatformConfig local = 3;
    CoreweavePlatformConfig coreweave = 4;
  }
}

// ============================================================================
// PROVIDER / GROUP CONFIGURATION
// ============================================================================

// Manual (pre-existing hosts) configuration for scale groups
message ManualProvider {
  repeated string hosts = 1;
  string ssh_user = 2;           // Default: "root"
  string ssh_key_file = 3;
}

// ============================================================================
// VM CONFIGURATION (for platform.create_vm())
// ============================================================================

message GcpVmConfig {
  string zone = 1;
  string machine_type = 2;      // Default: "n2-standard-4"
  int32 boot_disk_size_gb = 3;  // Default: 50
}

message ManualVmConfig {
  string host = 1;
  string ssh_user = 2;          // Default: "root"
  string ssh_key_file = 3;
}

message VmConfig {
  string name = 1;
  map<string, string> labels = 2;
  map<string, string> metadata = 3;
  oneof platform {
    GcpVmConfig gcp = 10;
    ManualVmConfig manual = 11;
  }
}

// ============================================================================
// SLICE CONFIGURATION (for platform.create_slice())
// ============================================================================

message GcpSliceConfig {
  enum GcpSliceMode {
    GCP_SLICE_MODE_TPU = 0;
    GCP_SLICE_MODE_VM = 1;
  }

  GcpSliceMode mode = 6;
  string zone = 1;
  string runtime_version = 2;
  reserved 3;  // was: preemptible (moved to SliceConfig)
  string topology = 4;
  reserved 5;  // was: zones (each slice/scaling group operates in a single zone)
  string machine_type = 7;      // Required for mode=GCP_SLICE_MODE_VM
  reserved 8;  // was: boot_disk_size_gb (moved to SliceConfig.disk_size_gb)
}

message CoreweaveSliceConfig {
  string region = 1;
  string instance_type = 2;     // e.g. "gd-8xh100ib-i128"
  string gpu_class = 4;         // e.g. "H100"
  bool infiniband = 5;          // request rdma/ib: 1
}

message ManualSliceConfig {
  repeated string hosts = 1;
  string ssh_user = 2;          // Default: "root"
  string ssh_key_file = 3;
}

message LocalSliceConfig {}

message SliceConfig {
  string name_prefix = 1;
  int32 num_vms = 2;
  AcceleratorType accelerator_type = 3;
  string accelerator_variant = 4;
  map<string, string> labels = 5;
  bool preemptible = 6;
  int32 gpu_count = 7;          // number of GPUs per VM (populated from ScaleGroupResources)
  int32 disk_size_gb = 8;       // boot disk size in GB (populated from ScaleGroupResources)
  oneof platform {
    GcpSliceConfig gcp = 10;
    CoreweaveSliceConfig coreweave = 11;
    ManualSliceConfig manual = 12;
    LocalSliceConfig local = 13;
  }
}

// ============================================================================
// SCALE GROUP CONFIGURATION
// ============================================================================

// Device/accelerator type for scale groups
enum AcceleratorType {
  ACCELERATOR_TYPE_UNSPECIFIED = 0;
  ACCELERATOR_TYPE_CPU = 1;
  ACCELERATOR_TYPE_GPU = 2;
  ACCELERATOR_TYPE_TPU = 3;
}

// Reserved: VmType enum was removed (dispatch now via SliceConfig.WhichOneof("platform"))
// enum VmType { ... } used field numbers 0-4
// Callers should use slice_template.WhichOneof("platform") instead.

// Resources available per slice in a scale group.
message ScaleGroupResources {
  int32 cpu_millicores = 1;  // CPU in millicores (1000 = 1 core)
  int64 memory_bytes = 2;
  int64 disk_bytes = 3;
  int32 gpu_count = 4;
  int32 tpu_count = 5;
}

message WorkerSettings {
  map<string, string> attributes = 1;
  map<string, string> env = 2;
}

// Configuration for a scale group
message ScaleGroupConfig {
  string name = 1;
  reserved 2;  // was: vm_type (removed, use slice_template.WhichOneof)

  // Scaling policy
  int32 min_slices = 3 [features.field_presence = EXPLICIT];
  int32 max_slices = 4 [features.field_presence = EXPLICIT];

  // Device configuration (kept on ScaleGroupConfig for demand matching)
  AcceleratorType accelerator_type = 9;
  string accelerator_variant = 10;
  reserved 11;  // was: topology (now in slice_template.gcp)
  reserved 12;  // was: runtime_version (now in slice_template.gcp)
  reserved 13;  // was: preemptible (moved to SliceConfig)
  ScaleGroupResources resources = 14;
  int32 num_vms = 15 [features.field_presence = EXPLICIT];

  reserved 20;  // was: zones (now in slice_template.gcp.zone)

  // Priority for waterfall routing (lower = higher priority, default 100)
  int32 priority = 30 [features.field_presence = EXPLICIT];

  reserved 40;  // was: manual (now in slice_template.manual)

  // What to create when scaling up — the slice template
  SliceConfig slice_template = 50;
  WorkerSettings worker = 60;
}

// ============================================================================
// WORKER CONFIGURATION
// ============================================================================

// Everything the worker process needs. Built by autoscaler from
// defaults.worker + per-scale-group overrides.
message WorkerConfig {
  // Worker container image (used by bootstrap, not by the worker process itself)
  string docker_image = 1;

  // Network
  string host = 2;                           // e.g. "0.0.0.0"
  int32 port = 3;                            // e.g. 10001
  string port_range = 4;                     // e.g. "30000-40000"

  // Identity
  string worker_id = 5;                      // auto-generated if empty
  string controller_address = 6;             // e.g. "10.0.0.1:10000"

  // Storage
  string cache_dir = 7;
  string log_prefix = 8;                     // URI prefix for logs

  // Task defaults
  string default_task_image = 9;
  map<string, string> default_task_env = 10;
  string runtime = 11;                       // "docker" or "kubernetes"

  // Accelerator (from scale group, not env vars)
  AcceleratorType accelerator_type = 20;
  string accelerator_variant = 21;
  int32 gpu_count = 22;

  // Scheduling attributes
  map<string, string> worker_attributes = 30;

  // Timing
  iris.time.Duration poll_interval = 40;
  iris.time.Duration heartbeat_timeout = 41;

  // Platform config (for image resolution — worker creates lightweight platform)
  PlatformConfig platform = 50;
}

// SSH configuration for manual hosts
message SshConfig {
  string user = 1;                        // Default: "root"
  string key_file = 2;                    // Path to SSH private key
  int32 port = 3;                         // Default: 22
  iris.time.Duration connect_timeout = 4;  // Default: 30s
}

// ============================================================================
// STORAGE CONFIGURATION
// ============================================================================

message StorageConfig {
  string bundle_prefix = 1;  // URI prefix for job bundles (e.g. s3://iris/bundles, gs://bucket/path)
  string log_prefix = 2;     // URI prefix for task logs (e.g. s3://iris/logs)
}

// ============================================================================
// CONTROLLER CONFIGURATION
// ============================================================================

// GCP-managed controller configuration
message GcpControllerConfig {
  string zone = 1;              // Zone to create controller VM in
  string machine_type = 2;      // Default: "n2-standard-4"
  int32 boot_disk_size_gb = 3;  // Default: 50
  int32 port = 4;               // Default: 10000
}

// Manually-managed controller configuration (SSH bootstrap)
message ManualControllerConfig {
  string host = 1;
  int32 port = 3;               // Default: 10000
}

// Locally-managed controller configuration (in-process)
message LocalControllerConfig {
  int32 port = 1;               // 0 = auto-assign
}

// CoreWeave controller configuration (Kubernetes Deployment + Service)
message CoreweaveControllerConfig {
  int32 port = 1;               // default: 10000
  string service_name = 2;      // K8s Service name for discovery
  string scale_group = 3;       // Scale group whose NodePool the controller runs on (required)
}

// Controller configuration using oneof for type-safe dispatch
message ControllerVmConfig {
  string image = 10;            // Controller docker image (shared by all controller types)
  iris.time.Duration worker_timeout = 12;  // Default: 60s
  int32 heartbeat_failure_threshold = 13;  // Consecutive heartbeat failures before marking worker dead (default: 10)
  oneof controller {
    GcpControllerConfig gcp = 1;
    ManualControllerConfig manual = 2;
    LocalControllerConfig local = 3;
    CoreweaveControllerConfig coreweave = 4;
  }
}

// ============================================================================
// DEFAULTS CONFIGURATION
// ============================================================================

message AutoscalerConfig {
  iris.time.Duration evaluation_interval = 1;  // Default: 10s
  iris.time.Duration scale_up_delay = 3;       // Default: 60s
  iris.time.Duration scale_down_delay = 4;     // Default: 300s
  iris.time.Duration startup_grace_period = 5; // Default: 30min — time for new slices to boot and register workers
  iris.time.Duration heartbeat_grace_period = 6; // Default: 5min — time after last worker heartbeat before reaping slice
}

message DefaultsConfig {
  SshConfig ssh = 2;
  AutoscalerConfig autoscaler = 3;
  reserved 4;  // was: BootstrapConfig bootstrap
  reserved 5;  // was: string default_task_image
  WorkerConfig worker = 6;
}

// ============================================================================
// ROOT CLUSTER CONFIGURATION
// ============================================================================

// Full cluster configuration - single source of truth
message IrisClusterConfig {
  // Platform settings
  PlatformConfig platform = 10;
  DefaultsConfig defaults = 11;
  StorageConfig storage = 12;

  // Controller settings
  ControllerVmConfig controller = 31;

  // Scale groups (name -> config)
  map<string, ScaleGroupConfig> scale_groups = 50;
}
