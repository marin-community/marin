// Copyright 2025 The Marin Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

edition = "2023";

package iris.logging;

import "time.proto";

// Log entry for task execution.
// Used for both RPC responses and GCS persistence.
message LogEntry {
  iris.time.Timestamp timestamp = 1;
  string source = 2;  // "stdout", "stderr", or "build"
  string data = 3;    // Log line content
  int32 attempt_id = 4;  // Which attempt produced this log
}

// Collection of log entries for a single source (stdout/stderr/build).
// Written to GCS as JSONL (one LogEntry per line).
message LogBatch {
  repeated LogEntry entries = 1;
}

// Task attempt metadata persisted to GCS.
// Written once on task completion to metadata.json.
message TaskAttemptMetadata {
  string task_id = 1;                        // Full task ID: "/job/path/task/0"
  int32 attempt_id = 2;
  string worker_id = 3;

  iris.time.Timestamp start_time = 4;
  iris.time.Timestamp end_time = 5;

  int32 exit_code = 6;
  bool oom_killed = 7;
  int32 status = 8;  // TaskState enum value from cluster.proto
  string error_message = 9;

  // Resource usage (if available)
  ResourceUsage resource_usage = 10;
}

// Resource usage statistics for a task attempt.
message ResourceUsage {
  int64 peak_memory_bytes = 1;
  double cpu_seconds = 2;
  int64 gpu_memory_bytes = 3;
}
