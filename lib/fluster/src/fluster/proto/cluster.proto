// Copyright 2025 The Marin Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package fluster.cluster;

option py_generic_services = true;

// ============================================================================
// SHARED TYPES
// ============================================================================

message Empty {}

enum JobState {
  JOB_STATE_UNSPECIFIED = 0;
  JOB_STATE_PENDING = 1;
  JOB_STATE_BUILDING = 2;
  JOB_STATE_RUNNING = 3;
  JOB_STATE_SUCCEEDED = 4;
  JOB_STATE_FAILED = 5;
  JOB_STATE_KILLED = 6;
  JOB_STATE_WORKER_FAILED = 7;  // Worker died, job may be retried
  JOB_STATE_UNSCHEDULABLE = 8;  // Couldn't be scheduled within timeout
}

message ResourceUsage {
  int64 memory_mb = 1;
  int64 disk_mb = 2;
  int32 cpu_millicores = 3;
  int64 memory_peak_mb = 4;
  int32 cpu_percent = 5;
  int32 process_count = 6;
}

message BuildMetrics {
  int64 build_started_ms = 1;
  int64 build_finished_ms = 2;
  bool from_cache = 3;
  string image_tag = 4;
}

message JobStatus {
  string job_id = 1;
  JobState state = 2;
  int32 exit_code = 3;
  string error = 4;
  int64 started_at_ms = 5;
  int64 finished_at_ms = 6;

  // Port allocations
  map<string, int32> ports = 7;

  ResourceUsage resource_usage = 8;

  // Status message for current phase (e.g., "downloading bundle", "populating uv cache")
  string status_message = 9;

  BuildMetrics build_metrics = 10;

  // Worker ID (populated by controller, not worker)
  string worker_id = 11;
}



// ============================================================================
// RESOURCE SPECIFICATION
// ============================================================================

// Device configuration - used in ResourceSpec
message DeviceConfig {
  oneof device {
    CpuDevice cpu = 1;
    GpuDevice gpu = 2;
    TpuDevice tpu = 3;
  }
}

message CpuDevice {
  string variant = 1;  // Always "cpu"
}

message GpuDevice {
  string variant = 1;  // e.g., "A100", "H100", "auto"
  int32 count = 2;     // Number of GPUs
}

message TpuDevice {
  string variant = 1;       // e.g., "v5litepod-16", "v4-8"
  string topology = 2;      // topology spec (e.g., "2x2x1")
}

// Unified resource specification for jobs
// Used by both controller (for scheduling) and worker (for enforcement)
message ResourceSpec {
  // Compute resources
  int32 cpu = 1;              // Number of CPU cores
  string memory = 2;          // RAM (e.g., "8g", "16g", "128m")
  string disk = 3;            // Disk space (e.g., "1g", "100g")

  // Device configuration
  DeviceConfig device = 5;

  // Multi-instance configuration
  int32 replicas = 6;         // Number of replicas/slices

  // Scheduling preferences
  bool preemptible = 7;
  repeated string regions = 8; // Preferred cloud regions
}

// ============================================================================
// ENVIRONMENT CONFIGURATION
// ============================================================================

// Job environment configuration
// Exactly one of workspace or docker_image must be set (enforced in client)
message EnvironmentConfig {
  oneof source {
    string workspace = 1;        // Path to workspace root for uv-based execution
  }

  repeated string pip_packages = 2;  // Additional pip packages to install
  map<string, string> env_vars = 3;  // Environment variables to set
  repeated string extras = 4;         // Extra dependency groups for uv (e.g., ["tpu", "eval"])
}

// ============================================================================
// CONTROLLER MESSAGES (Job Management & Endpoint Registry)
// ============================================================================

message LaunchJobRequest {
  string name = 1;
  bytes serialized_entrypoint = 2;   // cloudpickle(Entrypoint)
  ResourceSpec resources = 3;         // Full resource specification
  EnvironmentConfig environment = 4;  // Environment configuration

  // Bundle information - either provide gcs_path OR blob (not both)
  // TODO -- make this oneof bundle_source or bundle_gcs
  // OR STOP OVEROPTIMIZING AND JUST SEND THE BLOB RUSSELL
  string bundle_gcs_path = 5;        // gs://bucket/path/bundle.zip
  string bundle_hash = 6;            // SHA256 hash for caching
  bytes bundle_blob = 7;             // Direct bundle upload (controller writes to bundle_dir)

  // Scheduling timeout - job fails with UNSCHEDULABLE if not scheduled within this time
  // 0 means no timeout (wait forever)
  int32 scheduling_timeout_seconds = 8;

  // Named ports to allocate (e.g., ["http", "grpc", "actor"])
  // Worker allocates ports and injects FLUSTER_PORT_<NAME> env vars into the container
  repeated string ports = 9;
}

message LaunchJobResponse {
  string job_id = 1;
}

message ListJobsRequest {
  string namespace = 1;
}

message GetJobStatusRequest {
  string job_id = 1;
}

message GetJobStatusResponse {
  JobStatus job = 1;
}

message TerminateJobRequest {
  string job_id = 1;
}

message ListJobsResponse {
  repeated JobStatus jobs = 1;
}

// Endpoint Registry (Generic service discovery - NOT actor-specific)

message Endpoint {
  string endpoint_id = 1;
  string name = 2;
  string address = 3;              // host:port
  string job_id = 4;
  string namespace = 5;
  map<string, string> metadata = 6;
}

message RegisterEndpointRequest {
  string name = 1;
  string address = 2;
  string job_id = 3;
  string namespace = 4;
  map<string, string> metadata = 5;
}

message RegisterEndpointResponse {
  string endpoint_id = 1;
}

message UnregisterEndpointRequest {
  string endpoint_id = 1;
}

message LookupEndpointRequest {
  string name = 1;
  string namespace = 2;
}

message LookupEndpointResponse {
  Endpoint endpoint = 1;
}

message ListEndpointsRequest {
  string prefix = 1;
  string namespace = 2;
}

message ListEndpointsResponse {
  repeated Endpoint endpoints = 1;
}

// Worker Registration and Heartbeat

message WorkerInfo {
  string worker_id = 1;
  string address = 2;              // host:port for WorkerService
  ResourceSpec resources = 3;      // Worker capabilities
  int64 registered_at_ms = 4;
}

message RegisterWorkerRequest {
  string worker_id = 1;
  string address = 2;
  ResourceSpec resources = 3;
}

message RegisterWorkerResponse {
  bool accepted = 1;
  string controller_address = 2;   // For callbacks
}

message HeartbeatRequest {
  string worker_id = 1;
  int64 since_ms = 2;              // Return jobs modified since this timestamp
}

message HeartbeatResponse {
  repeated JobStatus jobs = 1;     // Jobs running/completed since since_ms
  int64 timestamp_ms = 2;
}

message WorkerHealthStatus {
  string worker_id = 1;
  bool healthy = 2;
  int32 consecutive_failures = 3;
  int64 last_heartbeat_ms = 4;
  repeated string running_job_ids = 5;
}

message ListWorkersRequest {}

message ListWorkersResponse {
  repeated WorkerHealthStatus workers = 1;
}

// ============================================================================
// WORKER MESSAGES (Job Execution)
// ============================================================================

message RunJobRequest {
  string job_id = 1;

  // Serialized Python objects and workspace bundle for execution
  bytes serialized_entrypoint = 2;   // cloudpickle(Entrypoint)
  EnvironmentConfig environment = 3;  // Environment configuration
  string bundle_gcs_path = 4;        // gs://bucket/path/bundle.zip

  // Resource specification
  ResourceSpec resources = 6;

  int32 timeout_seconds = 8;

  // Port requests
  repeated string ports = 9;
}

message RunJobResponse {
  string job_id = 1;
  JobState state = 2;
}

message GetStatusRequest {
  string job_id = 1;
}

message LogEntry {
  int64 timestamp_ms = 1;
  string source = 2;  // "stdout", "stderr", or "build"
  string data = 3;    // Log line content
}

message FetchLogsFilter {
  string regex = 1;
  int64 start_line = 2;
  int64 start_ms = 3;
  int64 end_ms = 4;
  int64 max_lines = 5;
}

message FetchLogsRequest {
  string job_id = 1;
  FetchLogsFilter filter = 2;
}

message FetchLogsResponse {
  repeated LogEntry logs = 1;
}

message KillJobRequest {
  string job_id = 1;
  int32 term_timeout_ms = 2; // Time to wait for graceful termination before SIGKILL
}

message HealthResponse {
  bool healthy = 1;
  int64 uptime_ms = 2;
  int32 running_jobs = 3;
}

// ============================================================================
// SERVICES
// ============================================================================

service ControllerService {
  // Job lifecycle
  rpc LaunchJob(LaunchJobRequest) returns (LaunchJobResponse);
  rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);
  rpc TerminateJob(TerminateJobRequest) returns (Empty);
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);

  // Worker management
  rpc RegisterWorker(RegisterWorkerRequest) returns (RegisterWorkerResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc ListWorkers(ListWorkersRequest) returns (ListWorkersResponse);

  // Endpoint registry (generic service discovery)
  rpc RegisterEndpoint(RegisterEndpointRequest) returns (RegisterEndpointResponse);
  rpc UnregisterEndpoint(UnregisterEndpointRequest) returns (Empty);
  rpc LookupEndpoint(LookupEndpointRequest) returns (LookupEndpointResponse);
  rpc ListEndpoints(ListEndpointsRequest) returns (ListEndpointsResponse);
}

service WorkerService {
  rpc RunJob(RunJobRequest) returns (RunJobResponse);
  rpc GetJobStatus(GetStatusRequest) returns (JobStatus);
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
  rpc FetchLogs(FetchLogsRequest) returns (FetchLogsResponse);
  rpc KillJob(KillJobRequest) returns (Empty);
  rpc HealthCheck(Empty) returns (HealthResponse);
}
