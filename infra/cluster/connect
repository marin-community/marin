#!/bin/bash

# Load cluster ports from yaml file
# You might need to install yq (https://kislyuk.github.io/yq/)
# brew install yq

if ! command -v screen &> /dev/null
then
    echo "screen could not be found. Please install it."
    exit 1
fi

if ! command -v yq &> /dev/null
then
    echo "yq could not be found. Please install it (brew install yq)."
    exit 1
fi


while IFS= read -r cluster_port_pair; do
  cluster_name=$(echo "$cluster_port_pair" | awk -F ': ' '{print $1}')
  port=$(echo "$cluster_port_pair" | awk -F ': ' '{print $2}')

  SCREEN_NAME="marin-${cluster_name}-dashboard"

  # Check if a screen session with the given name already exists
  if screen -list | grep -q "$SCREEN_NAME"; then
    echo "Screen session '$SCREEN_NAME' already exists. Please detach or kill it first."
    continue # Skip to the next cluster
  fi

  screen -S "$SCREEN_NAME" ray dashboard --port=$port ../clusters.yaml
  screen -r "$SCREEN_NAME"

  echo "Screen session '$SCREEN_NAME' created and attached for cluster '$cluster_name'."

done < <(yq -r 'to_entries | .[] | .key + ": " + .value' infra/cluster/clusters.yaml)


echo "Finished creating screen sessions for all clusters."
