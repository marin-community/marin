<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Directory Diff Report</title>
    <style>
      :root {
        --bg: #f6f8fb;
        --surface: #ffffff;
        --ink: #111827;
        --muted: #6b7280;
        --line: #e5e7eb;
        --changed: #b45309;
        --added: #166534;
        --removed: #b91c1c;
        --unchanged: #4b5563;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      main { max-width: 1180px; margin: 0 auto; padding: 24px 20px 40px; }
      .panel {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 14px 16px;
      }
      .summary {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
        margin-top: 12px;
      }
      .metric {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        background: #fafafa;
      }
      .metric .label { color: var(--muted); font-size: 12px; }
      .metric .value { font-size: 22px; font-weight: 700; }
      .filters { color: var(--muted); font-size: 14px; margin-top: 10px; }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
      }
      th, td {
        text-align: left;
        border-bottom: 1px solid var(--line);
        padding: 10px 12px;
      }
      th {
        background: #f9fafb;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-size: 12px;
      }
      td.num {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }
      a { color: #0059b8; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .status {
        display: inline-block;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        text-transform: uppercase;
        font-weight: 600;
      }
      .status.changed { color: var(--changed); background: #ffedd5; }
      .status.added { color: var(--added); background: #dcfce7; }
      .status.removed { color: var(--removed); background: #fee2e2; }
      .status.unchanged { color: var(--unchanged); background: #e5e7eb; }
      .diff-section {
        margin-top: 18px;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
      }
      .diff-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .diff-header h2 {
        margin: 6px 0 10px;
        font-size: 18px;
      }
      table.diff {
        width: 100%;
        border-collapse: collapse;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
        background: #fff;
      }
      .diff th, .diff td { padding: 2px 6px; vertical-align: top; }
      .diff_next { white-space: nowrap; }
      .diff_add { background: #e8f5e9; }
      .diff_sub { background: #ffebee; }
      .diff_chg { background: #fff8e1; }
      .diff_header { background: #f3f4f6; }
    </style>
  </head>
  <body>
    <main id="top">
      <section class="panel">
        <h1>Directory Diff Report</h1>
        <div><strong>Left:</strong> experiments/grug/base</div>
        <div><strong>Right:</strong> experiments/grug/moe</div>
        <div class="filters"><strong>Filter:</strong> .py, .pyi, .js, .jsx, .ts, .tsx</div>
        <div class="filters"><strong>Generated:</strong> 2026-02-28 07:37:46Z</div>
        <div class="filters"><strong>Inline Diffs:</strong> 3 files</div>
        <div class="summary">
          <div class="metric"><div class="label">Changed</div><div class="value">3</div></div>
          <div class="metric"><div class="label">Added</div><div class="value">0</div></div>
          <div class="metric"><div class="label">Removed</div><div class="value">0</div></div>
          <div class="metric"><div class="label">Unchanged</div><div class="value">1</div></div>
        </div>
      </section>
      <table>
        <thead>
          <tr>
            <th>File</th>
            <th>Status</th>
            <th>Lines Added</th>
            <th>Lines Deleted</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><a href="#file-1">launch.py</a></td><td><span class="status changed">changed</span></td><td class="num">+23</td><td class="num">-20</td></tr><tr><td><a href="#file-2">model.py</a></td><td><span class="status changed">changed</span></td><td class="num">+182</td><td class="num">-40</td></tr><tr><td><a href="#file-3">train.py</a></td><td><span class="status changed">changed</span></td><td class="num">+7</td><td class="num">-4</td></tr><tr><td>__init__.py</td><td><span class="status unchanged">unchanged</span></td><td class="num">+0</td><td class="num">-0</td></tr>
        </tbody>
      </table>
      <section class="diff-section" id="file-1"><div class="diff-header"><h2>launch.py</h2><span class="status changed">changed</span></div>
    <table class="diff" id="difflib_chg_to0__top"
           cellspacing="0" cellpadding="0" rules="groups" >
        <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
        <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
        <thead><tr><th class="diff_next"><br /></th><th colspan="2" class="diff_header">experiments/grug/base/launch.py</th><th class="diff_next"><br /></th><th colspan="2" class="diff_header">experiments/grug/moe/launch.py</th></tr></thead>
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__0"><a href="#difflib_chg_to0__0">f</a></td><td class="diff_header" id="from0_1">1</td><td nowrap="nowrap">#&nbsp;Copyright&nbsp;2025&nbsp;The&nbsp;Marin&nbsp;Authors</td><td class="diff_next"><a href="#difflib_chg_to0__0">f</a></td><td class="diff_header" id="to0_1">1</td><td nowrap="nowrap">#&nbsp;Copyright&nbsp;2025&nbsp;The&nbsp;Marin&nbsp;Authors</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_2">2</td><td nowrap="nowrap">#&nbsp;SPDX-License-Identifier:&nbsp;Apache-2.0</td><td class="diff_next"></td><td class="diff_header" id="to0_2">2</td><td nowrap="nowrap">#&nbsp;SPDX-License-Identifier:&nbsp;Apache-2.0</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to0__1"></td><td class="diff_header" id="from0_3">3</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_3">3</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__1">n</a></td><td class="diff_header" id="from0_4">4</td><td nowrap="nowrap">"""Template:&nbsp;grug-<span class="diff_chg">bas</span>e&nbsp;trial&nbsp;run.</td><td class="diff_next"><a href="#difflib_chg_to0__1">n</a></td><td class="diff_header" id="to0_4">4</td><td nowrap="nowrap">"""Template:&nbsp;grug-<span class="diff_chg">mo</span>e&nbsp;trial&nbsp;run.</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_5">5</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_5">5</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__2">n</a></td><td class="diff_header" id="from0_6">6</td><td nowrap="nowrap">This&nbsp;keeps&nbsp;model,&nbsp;train&nbsp;loop,&nbsp;and&nbsp;launch&nbsp;wiring&nbsp;in&nbsp;`experiments/grug/<span class="diff_chg">bas</span>e`&nbsp;so</td><td class="diff_next"><a href="#difflib_chg_to0__2">n</a></td><td class="diff_header" id="to0_6">6</td><td nowrap="nowrap">This&nbsp;keeps&nbsp;model,&nbsp;train&nbsp;loop,&nbsp;and&nbsp;launch&nbsp;wiring&nbsp;in&nbsp;`experiments/grug/<span class="diff_chg">mo</span>e`&nbsp;so</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_7">7</td><td nowrap="nowrap"><span class="diff_sub">variants&nbsp;can&nbsp;be&nbsp;copied&nbsp;and&nbsp;modified&nbsp;in-place&nbsp;(for&nbsp;example&nbsp;MoE&nbsp;forks).</span></td><td class="diff_next"></td><td class="diff_header" id="to0_7">7</td><td nowrap="nowrap"><span class="diff_add">the&nbsp;MoE&nbsp;variant&nbsp;can&nbsp;be&nbsp;iterated&nbsp;independently&nbsp;from&nbsp;the&nbsp;dense&nbsp;base&nbsp;template.</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_8">8</td><td nowrap="nowrap">"""</td><td class="diff_next"></td><td class="diff_header" id="to0_8">8</td><td nowrap="nowrap">"""</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_9">9</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_9">9</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_10">10</td><td nowrap="nowrap">import&nbsp;dataclasses</td><td class="diff_next"></td><td class="diff_header" id="to0_10">10</td><td nowrap="nowrap">import&nbsp;dataclasses</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__2"></td><td class="diff_header" id="from0_25">25</td><td nowrap="nowrap">from&nbsp;marin.processing.tokenize&nbsp;import&nbsp;add_validation_sets_to_mixture</td><td class="diff_next"></td><td class="diff_header" id="to0_25">25</td><td nowrap="nowrap">from&nbsp;marin.processing.tokenize&nbsp;import&nbsp;add_validation_sets_to_mixture</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_26">26</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_26">26</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_27">27</td><td nowrap="nowrap">from&nbsp;experiments.defaults&nbsp;import&nbsp;default_validation_sets</td><td class="diff_next"></td><td class="diff_header" id="to0_27">27</td><td nowrap="nowrap">from&nbsp;experiments.defaults&nbsp;import&nbsp;default_validation_sets</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__3">n</a></td><td class="diff_header" id="from0_28">28</td><td nowrap="nowrap">from&nbsp;experiments.grug.<span class="diff_chg">bas</span>e.model&nbsp;import&nbsp;GrugModelConfig</td><td class="diff_next"><a href="#difflib_chg_to0__3">n</a></td><td class="diff_header" id="to0_28">28</td><td nowrap="nowrap">from&nbsp;experiments.grug.<span class="diff_chg">mo</span>e.model&nbsp;import&nbsp;GrugModelConfig</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_29">29</td><td nowrap="nowrap">from&nbsp;experiments.grug.<span class="diff_chg">bas</span>e.train&nbsp;import&nbsp;GrugEvalConfig,&nbsp;GrugRunConfig,&nbsp;GrugTrainerConfig,&nbsp;run_grug</td><td class="diff_next"></td><td class="diff_header" id="to0_29">29</td><td nowrap="nowrap">from&nbsp;experiments.grug.<span class="diff_chg">mo</span>e.train&nbsp;import&nbsp;GrugEvalConfig,&nbsp;GrugRunConfig,&nbsp;GrugTrainerConfig,&nbsp;run_grug</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_30">30</td><td nowrap="nowrap">from&nbsp;experiments.tootsie.exp1295_32b&nbsp;import&nbsp;nemotron_mix</td><td class="diff_next"></td><td class="diff_header" id="to0_30">30</td><td nowrap="nowrap">from&nbsp;experiments.tootsie.exp1295_32b&nbsp;import&nbsp;nemotron_mix</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to0__3"></td><td class="diff_header" id="from0_31">31</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_31">31</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_32">32</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_32">32</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_33">33</td><td nowrap="nowrap">@dataclass(frozen=True)</td><td class="diff_next"></td><td class="diff_header" id="to0_33">33</td><td nowrap="nowrap">@dataclass(frozen=True)</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__4">n</a></td><td class="diff_header" id="from0_34">34</td><td nowrap="nowrap">class&nbsp;Grug<span class="diff_chg">Bas</span>eLaunchConfig:</td><td class="diff_next"><a href="#difflib_chg_to0__4">n</a></td><td class="diff_header" id="to0_34">34</td><td nowrap="nowrap">class&nbsp;Grug<span class="diff_chg">Mo</span>eLaunchConfig:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_35">35</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"""Last-mile&nbsp;run&nbsp;config&nbsp;for&nbsp;the&nbsp;<span class="diff_chg">base</span>&nbsp;grug&nbsp;template.</td><td class="diff_next"></td><td class="diff_header" id="to0_35">35</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"""Last-mile&nbsp;run&nbsp;config&nbsp;for&nbsp;the&nbsp;<span class="diff_chg">MoE</span>&nbsp;grug&nbsp;template.</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_36">36</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_36">36</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_37">37</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;Keep&nbsp;this&nbsp;as&nbsp;the&nbsp;main&nbsp;entry&nbsp;point&nbsp;for&nbsp;day-to-day&nbsp;edits&nbsp;(model/data/optimizer/trainer/eval&nbsp;knobs).</td><td class="diff_next"></td><td class="diff_header" id="to0_37">37</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;Keep&nbsp;this&nbsp;as&nbsp;the&nbsp;main&nbsp;entry&nbsp;point&nbsp;for&nbsp;day-to-day&nbsp;edits&nbsp;(model/data/optimizer/trainer/eval&nbsp;knobs).</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_38">38</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"""</td><td class="diff_next"></td><td class="diff_header" id="to0_38">38</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"""</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__4"></td><td class="diff_header" id="from0_51">51</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;eval:&nbsp;GrugEvalConfig&nbsp;|&nbsp;None&nbsp;=&nbsp;field(default_factory=GrugEvalConfig)</td><td class="diff_next"></td><td class="diff_header" id="to0_51">51</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;eval:&nbsp;GrugEvalConfig&nbsp;|&nbsp;None&nbsp;=&nbsp;field(default_factory=GrugEvalConfig)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_52">52</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_52">52</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_53">53</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_53">53</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__5">n</a></td><td class="diff_header" id="from0_54">54</td><td nowrap="nowrap">GRUG_<span class="diff_sub">130</span>M_MODEL&nbsp;=&nbsp;GrugModelConfig(</td><td class="diff_next"><a href="#difflib_chg_to0__5">n</a></td><td class="diff_header" id="to0_54">54</td><td nowrap="nowrap">GRUG_M<span class="diff_add">OE_TRIAL</span>_MODEL&nbsp;=&nbsp;GrugModelConfig(</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to0__5"></td><td class="diff_header" id="from0_55">55</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;vocab_size=128_256,</td><td class="diff_next"></td><td class="diff_header" id="to0_55">55</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;vocab_size=128_256,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_56">56</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;hidden_dim=512,</td><td class="diff_next"></td><td class="diff_header" id="to0_56">56</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;hidden_dim=512,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_57">57</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;intermediate_dim=1792,</td><td class="diff_next"></td><td class="diff_header" id="to0_57">57</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;intermediate_dim=1792,</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__6">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to0__6">n</a></td><td class="diff_header" id="to0_58">58</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_expert_intermediate_dim=1792,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_59">59</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;num_experts=8,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_60">60</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;num_experts_per_token=2,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_58">58</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_layers=6,</td><td class="diff_next"></td><td class="diff_header" id="to0_61">61</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_layers=6,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_59">59</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_heads=8,</td><td class="diff_next"></td><td class="diff_header" id="to0_62">62</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_heads=8,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_60">60</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_kv_heads=8,</td><td class="diff_next"></td><td class="diff_header" id="to0_63">63</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_kv_heads=8,</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__6"></td><td class="diff_header" id="from0_83">83</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tracker</td><td class="diff_next"></td><td class="diff_header" id="to0_86">86</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tracker</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_84">84</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_87">87</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_85">85</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_88">88</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__7">n</a></td><td class="diff_header" id="from0_86">86</td><td nowrap="nowrap">def&nbsp;run_grug_<span class="diff_chg">bas</span>e_trial(config:&nbsp;Grug<span class="diff_chg">Bas</span>eLaunchConfig)&nbsp;-&gt;&nbsp;None:</td><td class="diff_next"><a href="#difflib_chg_to0__7">n</a></td><td class="diff_header" id="to0_89">89</td><td nowrap="nowrap">def&nbsp;run_grug_<span class="diff_chg">mo</span>e_trial(config:&nbsp;Grug<span class="diff_chg">Mo</span>eLaunchConfig)&nbsp;-&gt;&nbsp;None:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_87">87</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Map&nbsp;template&nbsp;launch&nbsp;knobs&nbsp;onto&nbsp;full&nbsp;Levanter&nbsp;TrainerConfig.</td><td class="diff_next"></td><td class="diff_header" id="to0_90">90</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Map&nbsp;template&nbsp;launch&nbsp;knobs&nbsp;onto&nbsp;full&nbsp;Levanter&nbsp;TrainerConfig.</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_88">88</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;trainer&nbsp;=&nbsp;TrainerConfig(</td><td class="diff_next"></td><td class="diff_header" id="to0_91">91</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;trainer&nbsp;=&nbsp;TrainerConfig(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_89">89</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id=config.run_id,</td><td class="diff_next"></td><td class="diff_header" id="to0_92">92</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id=config.run_id,</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__7"></td><td class="diff_header" id="from0_116">116</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;run_grug(run_config)</td><td class="diff_next"></td><td class="diff_header" id="to0_119">119</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;run_grug(run_config)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_117">117</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_120">120</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_118">118</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_121">121</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to0__8"><a href="#difflib_chg_to0__8">n</a></td><td class="diff_header" id="from0_119">119</td><td nowrap="nowrap">RESOLVED_RUN_ID&nbsp;=&nbsp;_resolve_run_id("grug-<span class="diff_chg">bas</span>e-trial")</td><td class="diff_next"><a href="#difflib_chg_to0__8">n</a></td><td class="diff_header" id="to0_122">122</td><td nowrap="nowrap">RESOLVED_RUN_ID&nbsp;=&nbsp;_resolve_run_id("grug-<span class="diff_chg">mo</span>e-trial")</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_120">120</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_123">123</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_121">121</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_124">124</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__9">n</a></td><td class="diff_header" id="from0_122">122</td><td nowrap="nowrap">grug_<span class="diff_chg">bas</span>e_trial&nbsp;=&nbsp;ExecutorStep(</td><td class="diff_next"><a href="#difflib_chg_to0__9">n</a></td><td class="diff_header" id="to0_125">125</td><td nowrap="nowrap">grug_<span class="diff_chg">mo</span>e_trial&nbsp;=&nbsp;ExecutorStep(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_123">123</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;name="grug/<span class="diff_chg">bas</span>e-trial",</td><td class="diff_next"></td><td class="diff_header" id="to0_126">126</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;name="grug/<span class="diff_chg">mo</span>e-trial",</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_124">124</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;fn=run_grug_<span class="diff_chg">bas</span>e_trial,</td><td class="diff_next"></td><td class="diff_header" id="to0_127">127</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;fn=run_grug_<span class="diff_chg">mo</span>e_trial,</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to0__9"></td><td class="diff_header" id="from0_125">125</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;config=Grug<span class="diff_chg">Bas</span>eLaunchConfig(</td><td class="diff_next"></td><td class="diff_header" id="to0_128">128</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;config=Grug<span class="diff_chg">Mo</span>eLaunchConfig(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_126">126</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;model=versioned(GRUG_<span class="diff_sub">130</span>M_MODEL),</td><td class="diff_next"></td><td class="diff_header" id="to0_129">129</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;model=versioned(GRUG_M<span class="diff_add">OE_TRIAL</span>_MODEL),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_127">127</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data=NEMOTRON_MIX_WITH_DEFAULT_VALIDATION,</td><td class="diff_next"></td><td class="diff_header" id="to0_130">130</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data=NEMOTRON_MIX_WITH_DEFAULT_VALIDATION,</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__10">n</a></td><td class="diff_header" id="from0_128">128</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;this_output_path()&nbsp;resolves&nbsp;to&nbsp;this&nbsp;step's&nbsp;output&nbsp;root&nbsp;(e.g.&nbsp;gs://.../grug/<span class="diff_chg">bas</span>e-trial-&lt;version&gt;).</td><td class="diff_next"><a href="#difflib_chg_to0__10">n</a></td><td class="diff_header" id="to0_131">131</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;this_output_path()&nbsp;resolves&nbsp;to&nbsp;this&nbsp;step's&nbsp;output&nbsp;root&nbsp;(e.g.&nbsp;gs://.../grug/<span class="diff_chg">mo</span>e-trial-&lt;version&gt;).</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_129">129</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_path=this_output_path(),</td><td class="diff_next"></td><td class="diff_header" id="to0_132">132</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_path=this_output_path(),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_130">130</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Keep&nbsp;run&nbsp;id&nbsp;out&nbsp;of&nbsp;versioning&nbsp;so&nbsp;changing&nbsp;job&nbsp;metadata&nbsp;doesn't&nbsp;create&nbsp;a&nbsp;new&nbsp;output&nbsp;path.</td><td class="diff_next"></td><td class="diff_header" id="to0_133">133</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Keep&nbsp;run&nbsp;id&nbsp;out&nbsp;of&nbsp;versioning&nbsp;so&nbsp;changing&nbsp;job&nbsp;metadata&nbsp;doesn't&nbsp;create&nbsp;a&nbsp;new&nbsp;output&nbsp;path.</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_131">131</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_id=RESOLVED_RUN_ID,</td><td class="diff_next"></td><td class="diff_header" id="to0_134">134</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_id=RESOLVED_RUN_ID,</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__10"></td><td class="diff_header" id="from0_135">135</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mp=versioned("params=float32,compute=bfloat16,output=bfloat16"),</td><td class="diff_next"></td><td class="diff_header" id="to0_138">138</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mp=versioned("params=float32,compute=bfloat16,output=bfloat16"),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_136">136</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tracker=WandbConfig(</td><td class="diff_next"></td><td class="diff_header" id="to0_139">139</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tracker=WandbConfig(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_137">137</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;project="marin",</td><td class="diff_next"></td><td class="diff_header" id="to0_140">140</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;project="marin",</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__11">n</a></td><td class="diff_header" id="from0_138">138</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags=["grug",&nbsp;"template"],</td><td class="diff_next"><a href="#difflib_chg_to0__11">n</a></td><td class="diff_header" id="to0_141">141</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags=["grug",&nbsp;"template"<span class="diff_add">,&nbsp;"moe"</span>],</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_139">139</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;group="grug-<span class="diff_chg">bas</span>e-trial",</td><td class="diff_next"></td><td class="diff_header" id="to0_142">142</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;group="grug-<span class="diff_chg">mo</span>e-trial",</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_140">140</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=None,&nbsp;&nbsp;#&nbsp;filled&nbsp;from&nbsp;run_id&nbsp;in&nbsp;_resolve_tracker</td><td class="diff_next"></td><td class="diff_header" id="to0_143">143</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=None,&nbsp;&nbsp;#&nbsp;filled&nbsp;from&nbsp;run_id&nbsp;in&nbsp;_resolve_tracker</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_141">141</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</td><td class="diff_next"></td><td class="diff_header" id="to0_144">144</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_142">142</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;optimizer=versioned(</td><td class="diff_next"></td><td class="diff_header" id="to0_145">145</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;optimizer=versioned(</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to0__11"></td><td class="diff_header" id="from0_172">172</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to0_175">175</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_173">173</td><td nowrap="nowrap">if&nbsp;__name__&nbsp;==&nbsp;"__main__":</td><td class="diff_next"></td><td class="diff_header" id="to0_176">176</td><td nowrap="nowrap">if&nbsp;__name__&nbsp;==&nbsp;"__main__":</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_174">174</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;executor_main(</td><td class="diff_next"></td><td class="diff_header" id="to0_177">177</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;executor_main(</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to0__top">t</a></td><td class="diff_header" id="from0_175">175</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;steps=[grug_<span class="diff_chg">bas</span>e_trial],</td><td class="diff_next"><a href="#difflib_chg_to0__top">t</a></td><td class="diff_header" id="to0_178">178</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;steps=[grug_<span class="diff_chg">mo</span>e_trial],</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_176">176</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;description="Template&nbsp;grug&nbsp;<span class="diff_sub">base&nbsp;130</span>M&nbsp;trial&nbsp;run&nbsp;(~2000&nbsp;steps)&nbsp;on&nbsp;Nemotron&nbsp;mix.",</td><td class="diff_next"></td><td class="diff_header" id="to0_179">179</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;description="Template&nbsp;grug&nbsp;M<span class="diff_add">oE</span>&nbsp;trial&nbsp;run&nbsp;(~2000&nbsp;steps)&nbsp;on&nbsp;Nemotron&nbsp;mix.",</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from0_177">177</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;)</td><td class="diff_next"></td><td class="diff_header" id="to0_180">180</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
        </tbody>
    </table><p><a href="#top">Back to top</a></p></section><section class="diff-section" id="file-2"><div class="diff-header"><h2>model.py</h2><span class="status changed">changed</span></div>
    <table class="diff" id="difflib_chg_to1__top"
           cellspacing="0" cellpadding="0" rules="groups" >
        <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
        <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
        <thead><tr><th class="diff_next"><br /></th><th colspan="2" class="diff_header">experiments/grug/base/model.py</th><th class="diff_next"><br /></th><th colspan="2" class="diff_header">experiments/grug/moe/model.py</th></tr></thead>
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__0"></td><td class="diff_header" id="from1_2">2</td><td nowrap="nowrap">#&nbsp;SPDX-License-Identifier:&nbsp;Apache-2.0</td><td class="diff_next"></td><td class="diff_header" id="to1_2">2</td><td nowrap="nowrap">#&nbsp;SPDX-License-Identifier:&nbsp;Apache-2.0</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_3">3</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_3">3</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_4">4</td><td nowrap="nowrap">import&nbsp;dataclasses</td><td class="diff_next"></td><td class="diff_header" id="to1_4">4</td><td nowrap="nowrap">import&nbsp;dataclasses</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__1">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__1">n</a></td><td class="diff_header" id="to1_5">5</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_5">5</td><td nowrap="nowrap">from&nbsp;dataclasses&nbsp;import&nbsp;dataclass</td><td class="diff_next"></td><td class="diff_header" id="to1_6">6</td><td nowrap="nowrap">from&nbsp;dataclasses&nbsp;import&nbsp;dataclass</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_6">6</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_7">7</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_7">7</td><td nowrap="nowrap">import&nbsp;equinox&nbsp;as&nbsp;eqx</td><td class="diff_next"></td><td class="diff_header" id="to1_8">8</td><td nowrap="nowrap">import&nbsp;equinox&nbsp;as&nbsp;eqx</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__1"></td><td class="diff_header" id="from1_11">11</td><td nowrap="nowrap">from&nbsp;haliax.jax_utils&nbsp;import&nbsp;named_call</td><td class="diff_next"></td><td class="diff_header" id="to1_12">12</td><td nowrap="nowrap">from&nbsp;haliax.jax_utils&nbsp;import&nbsp;named_call</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_12">12</td><td nowrap="nowrap">from&nbsp;jax&nbsp;import&nbsp;random</td><td class="diff_next"></td><td class="diff_header" id="to1_13">13</td><td nowrap="nowrap">from&nbsp;jax&nbsp;import&nbsp;random</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_13">13</td><td nowrap="nowrap">from&nbsp;jax.sharding&nbsp;import&nbsp;PartitionSpec&nbsp;as&nbsp;P</td><td class="diff_next"></td><td class="diff_header" id="to1_14">14</td><td nowrap="nowrap">from&nbsp;jax.sharding&nbsp;import&nbsp;PartitionSpec&nbsp;as&nbsp;P</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__2">n</a></td><td class="diff_header" id="from1_14">14</td><td nowrap="nowrap">from&nbsp;jax.sharding&nbsp;import&nbsp;reshard</td><td class="diff_next"><a href="#difflib_chg_to1__2">n</a></td><td class="diff_header" id="to1_15">15</td><td nowrap="nowrap">from&nbsp;jax.sharding&nbsp;import<span class="diff_add">&nbsp;get_abstract_mesh,</span>&nbsp;reshard</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__2"></td><td class="diff_header" id="from1_15">15</td><td nowrap="nowrap">from&nbsp;jaxtyping&nbsp;import&nbsp;Array,&nbsp;Float,&nbsp;Int,&nbsp;PRNGKeyArray</td><td class="diff_next"></td><td class="diff_header" id="to1_16">16</td><td nowrap="nowrap">from&nbsp;jaxtyping&nbsp;import&nbsp;Array,&nbsp;Float,&nbsp;Int,&nbsp;PRNGKeyArray</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_16">16</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_17">17</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__3"></td><td class="diff_header" id="from1_17">17</td><td nowrap="nowrap">from&nbsp;levanter.grug.attention&nbsp;import&nbsp;AttentionMask,&nbsp;RotaryConfig,&nbsp;apply_rotary_embedding,&nbsp;attention</td><td class="diff_next"></td><td class="diff_header" id="to1_18">18</td><td nowrap="nowrap">from&nbsp;levanter.grug.attention&nbsp;import&nbsp;AttentionMask,&nbsp;RotaryConfig,&nbsp;apply_rotary_embedding,&nbsp;attention</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__3">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__3">n</a></td><td class="diff_header" id="to1_19">19</td><td nowrap="nowrap"><span class="diff_add">from&nbsp;levanter.grug.grug_moe&nbsp;import&nbsp;MoeActivation,&nbsp;moe_mlp</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_18">18</td><td nowrap="nowrap">from&nbsp;levanter.grug.loss&nbsp;import&nbsp;fused_linear_softmax_cross_entropy_loss</td><td class="diff_next"></td><td class="diff_header" id="to1_20">20</td><td nowrap="nowrap">from&nbsp;levanter.grug.loss&nbsp;import&nbsp;fused_linear_softmax_cross_entropy_loss</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__4">n</a></td><td class="diff_header" id="from1_19">19</td><td nowrap="nowrap">from&nbsp;levanter.grug.sharding&nbsp;import<span class="diff_sub">&nbsp;Pbatch,</span>&nbsp;Pvocab,&nbsp;unshard</td><td class="diff_next"><a href="#difflib_chg_to1__4">n</a></td><td class="diff_header" id="to1_21">21</td><td nowrap="nowrap">from&nbsp;levanter.grug.sharding&nbsp;import&nbsp;Pvocab,&nbsp;unshard</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_22">22</td><td nowrap="nowrap"><span class="diff_add">from&nbsp;levanter.utils.activation&nbsp;import&nbsp;ActivationFunctionEnum</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_23">23</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_24">24</td><td nowrap="nowrap"><span class="diff_add">_DEFAULT_EP_CAPACITY_FACTOR&nbsp;=&nbsp;1.25</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_25">25</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_26">26</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_27">27</td><td nowrap="nowrap"><span class="diff_add">def&nbsp;_mesh_has_axis(mesh:&nbsp;jax.sharding.AbstractMesh&nbsp;|&nbsp;None,&nbsp;axis_name:&nbsp;str)&nbsp;-&gt;&nbsp;bool:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_28">28</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh&nbsp;is&nbsp;None&nbsp;or&nbsp;mesh.empty:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_29">29</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;False</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_30">30</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;axis_name&nbsp;in&nbsp;mesh.shape</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_31">31</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_32">32</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_33">33</td><td nowrap="nowrap"><span class="diff_add">def&nbsp;_mesh_axis_size(mesh:&nbsp;jax.sharding.AbstractMesh&nbsp;|&nbsp;None,&nbsp;axis_name:&nbsp;str)&nbsp;-&gt;&nbsp;int:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_34">34</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mesh&nbsp;is&nbsp;None&nbsp;or&nbsp;mesh.empty:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_35">35</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_36">36</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;int(mesh.shape.get(axis_name,&nbsp;1))</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_37">37</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_38">38</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_39">39</td><td nowrap="nowrap"><span class="diff_add">def&nbsp;_batch_spec(mesh:&nbsp;jax.sharding.AbstractMesh&nbsp;|&nbsp;None)&nbsp;-&gt;&nbsp;P:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_40">40</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;_mesh_has_axis(mesh,&nbsp;"expert"):</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_41">41</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;P(("data",&nbsp;"expert"))</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_42">42</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;P(("data",))</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_20">20</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_43">43</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__4"></td><td class="diff_header" id="from1_21">21</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_44">44</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_22">22</td><td nowrap="nowrap">@dataclass(frozen=True)</td><td class="diff_next"></td><td class="diff_header" id="to1_45">45</td><td nowrap="nowrap">@dataclass(frozen=True)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_23">23</td><td nowrap="nowrap">class&nbsp;GrugModelConfig:</td><td class="diff_next"></td><td class="diff_header" id="to1_46">46</td><td nowrap="nowrap">class&nbsp;GrugModelConfig:</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__5">n</a></td><td class="diff_header" id="from1_24">24</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"""Hyperparameters&nbsp;for&nbsp;the&nbsp;<span class="diff_chg">G</span>rug&nbsp;<span class="diff_chg">Llama-style</span>&nbsp;transformer."""</td><td class="diff_next"><a href="#difflib_chg_to1__5">n</a></td><td class="diff_header" id="to1_47">47</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"""Hyperparameters&nbsp;for&nbsp;the&nbsp;<span class="diff_chg">compact&nbsp;g</span>rug&nbsp;<span class="diff_chg">MoE</span>&nbsp;transformer."""</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_25">25</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_48">48</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__5"></td><td class="diff_header" id="from1_26">26</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;vocab_size:&nbsp;int</td><td class="diff_next"></td><td class="diff_header" id="to1_49">49</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;vocab_size:&nbsp;int</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_27">27</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;hidden_dim:&nbsp;int&nbsp;=&nbsp;2048</td><td class="diff_next"></td><td class="diff_header" id="to1_50">50</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;hidden_dim:&nbsp;int&nbsp;=&nbsp;2048</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_28">28</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;intermediate_dim:&nbsp;int&nbsp;=&nbsp;5632</td><td class="diff_next"></td><td class="diff_header" id="to1_51">51</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;intermediate_dim:&nbsp;int&nbsp;=&nbsp;5632</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__6">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__6">n</a></td><td class="diff_header" id="to1_52">52</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_expert_intermediate_dim:&nbsp;int&nbsp;=&nbsp;5632</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_53">53</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;num_experts:&nbsp;int&nbsp;=&nbsp;8</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_54">54</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;num_experts_per_token:&nbsp;int&nbsp;=&nbsp;2</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_29">29</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_layers:&nbsp;int&nbsp;=&nbsp;24</td><td class="diff_next"></td><td class="diff_header" id="to1_55">55</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_layers:&nbsp;int&nbsp;=&nbsp;24</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_30">30</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_heads:&nbsp;int&nbsp;=&nbsp;16</td><td class="diff_next"></td><td class="diff_header" id="to1_56">56</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_heads:&nbsp;int&nbsp;=&nbsp;16</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_31">31</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_kv_heads:&nbsp;int&nbsp;=&nbsp;16</td><td class="diff_next"></td><td class="diff_header" id="to1_57">57</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;num_kv_heads:&nbsp;int&nbsp;=&nbsp;16</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__6"></td><td class="diff_header" id="from1_43">43</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("vocab_size&nbsp;must&nbsp;be&nbsp;positive")</td><td class="diff_next"></td><td class="diff_header" id="to1_69">69</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("vocab_size&nbsp;must&nbsp;be&nbsp;positive")</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_44">44</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.max_seq_len&nbsp;&lt;=&nbsp;0:</td><td class="diff_next"></td><td class="diff_header" id="to1_70">70</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.max_seq_len&nbsp;&lt;=&nbsp;0:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_45">45</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("max_seq_len&nbsp;must&nbsp;be&nbsp;positive")</td><td class="diff_next"></td><td class="diff_header" id="to1_71">71</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("max_seq_len&nbsp;must&nbsp;be&nbsp;positive")</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__7">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__7">n</a></td><td class="diff_header" id="to1_72">72</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.num_experts&nbsp;&lt;=&nbsp;0:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_73">73</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("num_experts&nbsp;must&nbsp;be&nbsp;positive")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_74">74</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.num_experts_per_token&nbsp;&lt;=&nbsp;0:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_75">75</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("num_experts_per_token&nbsp;must&nbsp;be&nbsp;positive")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_76">76</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.num_experts_per_token&nbsp;&gt;&nbsp;self.num_experts:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_77">77</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("num_experts_per_token&nbsp;must&nbsp;be&nbsp;&lt;=&nbsp;num_experts")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_78">78</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.shared_expert_intermediate_dim&nbsp;&lt;&nbsp;0:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_79">79</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError("shared_expert_intermediate_dim&nbsp;must&nbsp;be&nbsp;non-negative")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_46">46</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_80">80</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_47">47</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@property</td><td class="diff_next"></td><td class="diff_header" id="to1_81">81</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@property</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_48">48</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;inferred_head_dim(self)&nbsp;-&gt;&nbsp;int:</td><td class="diff_next"></td><td class="diff_header" id="to1_82">82</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;inferred_head_dim(self)&nbsp;-&gt;&nbsp;int:</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__7"></td><td class="diff_header" id="from1_56">56</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_90">90</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_57">57</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_91">91</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_58">58</td><td nowrap="nowrap">class&nbsp;CausalSelfAttention(eqx.Module):</td><td class="diff_next"></td><td class="diff_header" id="to1_92">92</td><td nowrap="nowrap">class&nbsp;CausalSelfAttention(eqx.Module):</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__8">n</a></td><td class="diff_header" id="from1_59">59</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;w_q:&nbsp;jax.Array</span></td><td class="diff_next"><a href="#difflib_chg_to1__8">n</a></td><td class="diff_header" id="to1_93">93</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;w_q:&nbsp;Float[Array,&nbsp;"D&nbsp;NH"]</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_60">60</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;w_k:&nbsp;jax.Array</span></td><td class="diff_next"></td><td class="diff_header" id="to1_94">94</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;w_k:&nbsp;Float[Array,&nbsp;"D&nbsp;MH"]</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_61">61</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;w_v:&nbsp;jax.Array</span></td><td class="diff_next"></td><td class="diff_header" id="to1_95">95</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;w_v:&nbsp;Float[Array,&nbsp;"D&nbsp;MH"]</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_62">62</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;w_o:&nbsp;jax.Array</span></td><td class="diff_next"></td><td class="diff_header" id="to1_96">96</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;w_o:&nbsp;Float[Array,&nbsp;"NH&nbsp;D"]</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_63">63</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;cfg:&nbsp;GrugModelConfig&nbsp;=&nbsp;eqx.field(static=True)</td><td class="diff_next"></td><td class="diff_header" id="to1_97">97</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;cfg:&nbsp;GrugModelConfig&nbsp;=&nbsp;eqx.field(static=True)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_64">64</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_98">98</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__8"></td><td class="diff_header" id="from1_65">65</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod</td><td class="diff_next"></td><td class="diff_header" id="to1_99">99</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_66">66</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;init(cfg:&nbsp;GrugModelConfig,&nbsp;*,&nbsp;key:&nbsp;PRNGKeyArray)&nbsp;-&gt;&nbsp;"CausalSelfAttention":</td><td class="diff_next"></td><td class="diff_header" id="to1_100">100</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;init(cfg:&nbsp;GrugModelConfig,&nbsp;*,&nbsp;key:&nbsp;PRNGKeyArray)&nbsp;-&gt;&nbsp;"CausalSelfAttention":</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__9"></td><td class="diff_header" id="from1_67">67</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k_q,&nbsp;k_k,&nbsp;k_v,&nbsp;k_o&nbsp;=&nbsp;random.split(key,&nbsp;4)</td><td class="diff_next"></td><td class="diff_header" id="to1_101">101</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k_q,&nbsp;k_k,&nbsp;k_v,&nbsp;k_o&nbsp;=&nbsp;random.split(key,&nbsp;4)</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__9">n</a></td><td class="diff_header" id="from1_68">68</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d<span class="diff_chg">_</span>m<span class="diff_sub">odel</span>,&nbsp;<span class="diff_sub">n_</span>h<span class="diff_sub">eads,&nbsp;n_kv_heads,&nbsp;head_dim</span>&nbsp;=&nbsp;cfg.hidden_dim,&nbsp;cfg.num_heads,&nbsp;cfg.num_kv_heads,&nbsp;cfg.inferred_head_dim</td><td class="diff_next"><a href="#difflib_chg_to1__9">n</a></td><td class="diff_header" id="to1_102">102</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d<span class="diff_chg">,&nbsp;n,&nbsp;</span>m,&nbsp;h&nbsp;=&nbsp;cfg.hidden_dim,&nbsp;cfg.num_heads,&nbsp;cfg.num_kv_heads,&nbsp;cfg.inferred_head_dim</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_69">69</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;CausalSelfAttention(</td><td class="diff_next"></td><td class="diff_header" id="to1_103">103</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;CausalSelfAttention(</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__10">n</a></td><td class="diff_header" id="from1_70">70</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_q=reshard(_init_weight(k_q,&nbsp;(d<span class="diff_sub">_model</span>,&nbsp;n<span class="diff_chg">_</span>h<span class="diff_sub">eads&nbsp;*&nbsp;head_dim</span>),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</td><td class="diff_next"><a href="#difflib_chg_to1__10">n</a></td><td class="diff_header" id="to1_104">104</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_q=reshard(_init_weight(k_q,&nbsp;(d,&nbsp;n<span class="diff_chg">&nbsp;*&nbsp;</span>h),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_71">71</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_k=reshard(_init_weight(k_k,&nbsp;(d<span class="diff_chg">_</span>m<span class="diff_chg">odel,&nbsp;n_kv_</span>h<span class="diff_sub">eads&nbsp;*&nbsp;head_dim</span>),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</td><td class="diff_next"></td><td class="diff_header" id="to1_105">105</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_k=reshard(_init_weight(k_k,&nbsp;(d<span class="diff_chg">,&nbsp;</span>m<span class="diff_chg">&nbsp;*&nbsp;</span>h),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_72">72</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_v=reshard(_init_weight(k_v,&nbsp;(d<span class="diff_chg">_</span>m<span class="diff_chg">odel,&nbsp;n_kv_</span>h<span class="diff_sub">eads&nbsp;*&nbsp;head_dim</span>),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</td><td class="diff_next"></td><td class="diff_header" id="to1_106">106</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_v=reshard(_init_weight(k_v,&nbsp;(d<span class="diff_chg">,&nbsp;</span>m<span class="diff_chg">&nbsp;*&nbsp;</span>h),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_73">73</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_o=reshard(_init_weight(k_o,&nbsp;(n<span class="diff_chg">_</span>h<span class="diff_chg">ea</span>d<span class="diff_sub">s&nbsp;*&nbsp;head_dim,&nbsp;d_model</span>),&nbsp;cfg.initializer_std),&nbsp;P("model",&nbsp;"data")),</td><td class="diff_next"></td><td class="diff_header" id="to1_107">107</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_o=reshard(_init_weight(k_o,&nbsp;(n<span class="diff_chg">&nbsp;*&nbsp;</span>h<span class="diff_chg">,&nbsp;</span>d),&nbsp;cfg.initializer_std),&nbsp;P("model",&nbsp;"data")),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_74">74</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg=cfg,</td><td class="diff_next"></td><td class="diff_header" id="to1_108">108</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg=cfg,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_75">75</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td><td class="diff_next"></td><td class="diff_header" id="to1_109">109</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_76">76</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_110">110</td><td nowrap="nowrap"></td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__10"></td><td class="diff_header" id="from1_78">78</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__call__(self,&nbsp;x:&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"],&nbsp;mask:&nbsp;AttentionMask&nbsp;|&nbsp;jax.Array)&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"]:</td><td class="diff_next"></td><td class="diff_header" id="to1_112">112</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__call__(self,&nbsp;x:&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"],&nbsp;mask:&nbsp;AttentionMask&nbsp;|&nbsp;jax.Array)&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"]:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_79">79</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;head_dim&nbsp;=&nbsp;self.cfg.inferred_head_dim</td><td class="diff_next"></td><td class="diff_header" id="to1_113">113</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;head_dim&nbsp;=&nbsp;self.cfg.inferred_head_dim</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_80">80</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seq_len&nbsp;=&nbsp;x.shape[1]</td><td class="diff_next"></td><td class="diff_header" id="to1_114">114</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seq_len&nbsp;=&nbsp;x.shape[1]</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__11">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__11">n</a></td><td class="diff_header" id="to1_115">115</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch_spec&nbsp;=&nbsp;_batch_spec(get_abstract_mesh())</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_81">81</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_116">116</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_82">82</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q&nbsp;=&nbsp;rearrange(jnp.einsum("bsh,hd-&gt;bsd",&nbsp;x,&nbsp;self.w_q),&nbsp;"...&nbsp;(n&nbsp;d)&nbsp;-&gt;&nbsp;...&nbsp;n&nbsp;d",&nbsp;d=head_dim)</td><td class="diff_next"></td><td class="diff_header" id="to1_117">117</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q&nbsp;=&nbsp;rearrange(jnp.einsum("bsh,hd-&gt;bsd",&nbsp;x,&nbsp;self.w_q),&nbsp;"...&nbsp;(n&nbsp;d)&nbsp;-&gt;&nbsp;...&nbsp;n&nbsp;d",&nbsp;d=head_dim)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_83">83</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k&nbsp;=&nbsp;rearrange(jnp.einsum("bsh,hd-&gt;bsd",&nbsp;x,&nbsp;self.w_k),&nbsp;"...&nbsp;(m&nbsp;d)&nbsp;-&gt;&nbsp;...&nbsp;m&nbsp;d",&nbsp;d=head_dim)</td><td class="diff_next"></td><td class="diff_header" id="to1_118">118</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k&nbsp;=&nbsp;rearrange(jnp.einsum("bsh,hd-&gt;bsd",&nbsp;x,&nbsp;self.w_k),&nbsp;"...&nbsp;(m&nbsp;d)&nbsp;-&gt;&nbsp;...&nbsp;m&nbsp;d",&nbsp;d=head_dim)</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__11"></td><td class="diff_header" id="from1_85">85</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q,&nbsp;k&nbsp;=&nbsp;apply_rotary_embedding(q,&nbsp;k,&nbsp;seq_len=seq_len,&nbsp;head_dim=head_dim,&nbsp;rope=self.cfg.rope)</td><td class="diff_next"></td><td class="diff_header" id="to1_120">120</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q,&nbsp;k&nbsp;=&nbsp;apply_rotary_embedding(q,&nbsp;k,&nbsp;seq_len=seq_len,&nbsp;head_dim=head_dim,&nbsp;rope=self.cfg.rope)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_86">86</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn_out&nbsp;=&nbsp;attention(q,&nbsp;k,&nbsp;v,&nbsp;mask)</td><td class="diff_next"></td><td class="diff_header" id="to1_121">121</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn_out&nbsp;=&nbsp;attention(q,&nbsp;k,&nbsp;v,&nbsp;mask)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_87">87</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn_out&nbsp;=&nbsp;rearrange(attn_out,&nbsp;"...&nbsp;n&nbsp;d&nbsp;-&gt;&nbsp;...&nbsp;(n&nbsp;d)")</td><td class="diff_next"></td><td class="diff_header" id="to1_122">122</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn_out&nbsp;=&nbsp;rearrange(attn_out,&nbsp;"...&nbsp;n&nbsp;d&nbsp;-&gt;&nbsp;...&nbsp;(n&nbsp;d)")</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__12">n</a></td><td class="diff_header" id="from1_88">88</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;jnp.einsum("bsh,hd-&gt;bsd",&nbsp;attn_out,&nbsp;self.w_o,&nbsp;out_sharding=<span class="diff_sub">P</span>batch)</td><td class="diff_next"><a href="#difflib_chg_to1__12">n</a></td><td class="diff_header" id="to1_123">123</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;jnp.einsum("bsh,hd-&gt;bsd",&nbsp;attn_out,&nbsp;self.w_o,&nbsp;out_sharding=batch<span class="diff_add">_spec</span>)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_89">89</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_90">90</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_91">91</td><td nowrap="nowrap"><span class="diff_sub">class&nbsp;MLP(eqx.Module):</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_92">92</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;mlp_up:&nbsp;jax.Array</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_93">93</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;mlp_down:&nbsp;jax.Array</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_94">94</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_95">95</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_96">96</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;init(cfg:&nbsp;GrugModelConfig,&nbsp;*,&nbsp;key:&nbsp;PRNGKeyArray)&nbsp;-&gt;&nbsp;"MLP":</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_97">97</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k_up,&nbsp;k_down&nbsp;=&nbsp;random.split(key,&nbsp;2)</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_98">98</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d_model,&nbsp;d_ff&nbsp;=&nbsp;cfg.hidden_dim,&nbsp;cfg.intermediate_dim</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_99">99</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MLP(</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_100">100</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mlp_up=reshard(_init_weight(k_up,&nbsp;(d_model,&nbsp;d_ff),&nbsp;cfg.initializer_std),&nbsp;P("data",&nbsp;"model")),</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_101">101</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mlp_down=reshard(_init_weight(k_down,&nbsp;(d_ff,&nbsp;d_model),&nbsp;cfg.initializer_std),&nbsp;P("model",&nbsp;"data")),</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_102">102</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_103">103</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_104">104</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;@named_call</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_105">105</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__call__(self,&nbsp;x:&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"])&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"]:</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_106">106</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;up&nbsp;=&nbsp;jnp.einsum("bsh,hm-&gt;bsm",&nbsp;x,&nbsp;self.mlp_up)</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_107">107</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activated&nbsp;=&nbsp;jax.nn.relu(up)</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_108">108</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;jnp.einsum("bsm,mh-&gt;bsh",&nbsp;activated,&nbsp;self.mlp_down,&nbsp;out_sharding=Pbatch)</span></td><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_109">109</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_124">124</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_110">110</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_125">125</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_111">111</td><td nowrap="nowrap">class&nbsp;RMSNorm(eqx.Module):</td><td class="diff_next"></td><td class="diff_header" id="to1_126">126</td><td nowrap="nowrap">class&nbsp;RMSNorm(eqx.Module):</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__12"></td><td class="diff_header" id="from1_126">126</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(normed&nbsp;*&nbsp;weight).astype(dtype)</td><td class="diff_next"></td><td class="diff_header" id="to1_141">141</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(normed&nbsp;*&nbsp;weight).astype(dtype)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_127">127</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_142">142</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_128">128</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_143">143</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__13">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__13">n</a></td><td class="diff_header" id="to1_144">144</td><td nowrap="nowrap"><span class="diff_add">def&nbsp;_shared_dense_mlp(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_145">145</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;x:&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"],</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_146">146</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_w_up_gate:&nbsp;Float[Array,&nbsp;"D&nbsp;J2"],</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_147">147</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_w_down:&nbsp;Float[Array,&nbsp;"J&nbsp;D"],</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_148">148</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;*,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_149">149</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;activation:&nbsp;MoeActivation&nbsp;=&nbsp;ActivationFunctionEnum.silu,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_150">150</td><td nowrap="nowrap"><span class="diff_add">)&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"]:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_151">151</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(activation,&nbsp;ActivationFunctionEnum):</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_152">152</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activation_fn&nbsp;=&nbsp;activation.to_jax_fn()</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_153">153</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;else:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_154">154</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activation_fn&nbsp;=&nbsp;activation</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_155">155</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_156">156</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;b,&nbsp;s,&nbsp;_&nbsp;=&nbsp;x.shape</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_157">157</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;x_flat&nbsp;=&nbsp;rearrange(x,&nbsp;"b&nbsp;s&nbsp;d&nbsp;-&gt;&nbsp;(b&nbsp;s)&nbsp;d")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_158">158</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_dim&nbsp;=&nbsp;shared_w_down.shape[0]</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_159">159</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_up_gate&nbsp;=&nbsp;jnp.einsum("td,dm-&gt;tm",&nbsp;x_flat,&nbsp;shared_w_up_gate)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_160">160</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_gate,&nbsp;shared_up&nbsp;=&nbsp;jnp.split(shared_up_gate,&nbsp;[shared_dim],&nbsp;axis=-1)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_161">161</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;out_flat&nbsp;=&nbsp;jnp.einsum("tm,md-&gt;td",&nbsp;activation_fn(shared_gate)&nbsp;*&nbsp;shared_up,&nbsp;shared_w_down)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_162">162</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;rearrange(out_flat,&nbsp;"(b&nbsp;s)&nbsp;d&nbsp;-&gt;&nbsp;b&nbsp;s&nbsp;d",&nbsp;b=b,&nbsp;s=s)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_163">163</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_164">164</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_165">165</td><td nowrap="nowrap"><span class="diff_add">class&nbsp;MoEMLP(eqx.Module):</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_166">166</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;router:&nbsp;jax.Array</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_167">167</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;w_up_gate:&nbsp;jax.Array</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_168">168</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;w_down:&nbsp;jax.Array</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_169">169</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_w_up_gate:&nbsp;jax.Array&nbsp;|&nbsp;None</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_170">170</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;shared_w_down:&nbsp;jax.Array&nbsp;|&nbsp;None</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_171">171</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;cfg:&nbsp;GrugModelConfig&nbsp;=&nbsp;eqx.field(static=True)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_172">172</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_173">173</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_174">174</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;init(cfg:&nbsp;GrugModelConfig,&nbsp;*,&nbsp;key:&nbsp;PRNGKeyArray)&nbsp;-&gt;&nbsp;"MoEMLP":</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_175">175</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k_router,&nbsp;k_w_up_gate,&nbsp;k_w_down,&nbsp;k_shared_up_gate,&nbsp;k_shared_down&nbsp;=&nbsp;random.split(key,&nbsp;5)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_176">176</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;get_abstract_mesh()</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_177">177</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_178">178</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expert_axis_size&nbsp;=&nbsp;_mesh_axis_size(mesh,&nbsp;"expert")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_179">179</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;cfg.num_experts&nbsp;%&nbsp;expert_axis_size&nbsp;!=&nbsp;0:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_180">180</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f"num_experts={cfg.num_experts}&nbsp;must&nbsp;be&nbsp;divisible&nbsp;by&nbsp;expert&nbsp;axis&nbsp;size={expert_axis_size}")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_181">181</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_182">182</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expert_param_spec&nbsp;=&nbsp;P("expert",&nbsp;None,&nbsp;None)&nbsp;if&nbsp;_mesh_has_axis(mesh,&nbsp;"expert")&nbsp;else&nbsp;P(None,&nbsp;None,&nbsp;None)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_183">183</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_184">184</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d,&nbsp;e,&nbsp;i,&nbsp;j&nbsp;=&nbsp;(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_185">185</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg.hidden_dim,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_186">186</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg.num_experts,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_187">187</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg.intermediate_dim,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_188">188</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg.shared_expert_intermediate_dim,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_189">189</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_190">190</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_191">191</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_w_up_gate&nbsp;=&nbsp;None</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_192">192</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_w_down&nbsp;=&nbsp;None</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_193">193</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;j&nbsp;&gt;&nbsp;0:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_194">194</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_w_up_gate&nbsp;=&nbsp;reshard(_init_weight(k_shared_up_gate,&nbsp;(d,&nbsp;2&nbsp;*&nbsp;j),&nbsp;cfg.initializer_std),&nbsp;P(None,&nbsp;None))</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_195">195</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_w_down&nbsp;=&nbsp;reshard(_init_weight(k_shared_down,&nbsp;(j,&nbsp;d),&nbsp;cfg.initializer_std),&nbsp;P(None,&nbsp;None))</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_196">196</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_197">197</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MoEMLP(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_198">198</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;router=reshard(_init_weight(k_router,&nbsp;(d,&nbsp;e),&nbsp;cfg.initializer_std),&nbsp;P(None,&nbsp;None)),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_199">199</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_up_gate=reshard(_init_weight(k_w_up_gate,&nbsp;(e,&nbsp;d,&nbsp;2&nbsp;*&nbsp;i),&nbsp;cfg.initializer_std),&nbsp;expert_param_spec),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_200">200</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w_down=reshard(_init_weight(k_w_down,&nbsp;(e,&nbsp;i,&nbsp;d),&nbsp;cfg.initializer_std),&nbsp;expert_param_spec),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_201">201</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_w_up_gate=shared_w_up_gate,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_202">202</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_w_down=shared_w_down,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_203">203</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfg=cfg,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_204">204</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_205">205</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_206">206</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;@named_call</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_207">207</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__call__(self,&nbsp;x:&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"])&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;D"]:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_208">208</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b,&nbsp;s,&nbsp;_&nbsp;=&nbsp;x.shape</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_209">209</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x_flat&nbsp;=&nbsp;rearrange(x,&nbsp;"b&nbsp;s&nbsp;d&nbsp;-&gt;&nbsp;(b&nbsp;s)&nbsp;d")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_210">210</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;router_logits&nbsp;=&nbsp;jnp.einsum("td,de-&gt;te",&nbsp;x_flat,&nbsp;self.router)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_211">211</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topk_logits,&nbsp;selected_experts&nbsp;=&nbsp;jax.lax.top_k(router_logits,&nbsp;self.cfg.num_experts_per_token)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_212">212</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;combine_weights&nbsp;=&nbsp;jax.nn.softmax(topk_logits,&nbsp;axis=-1).astype(x.dtype)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_213">213</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_214">214</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;routed_flat&nbsp;=&nbsp;moe_mlp(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_215">215</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x_flat,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_216">216</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selected_experts.astype(jnp.int32),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_217">217</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;combine_weights,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_218">218</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.w_up_gate,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_219">219</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.w_down,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_220">220</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activation=ActivationFunctionEnum.silu,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_221">221</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh=get_abstract_mesh(),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_222">222</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;capacity_factor=_DEFAULT_EP_CAPACITY_FACTOR,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_223">223</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_224">224</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;routed&nbsp;=&nbsp;rearrange(routed_flat,&nbsp;"(b&nbsp;s)&nbsp;d&nbsp;-&gt;&nbsp;b&nbsp;s&nbsp;d",&nbsp;b=b,&nbsp;s=s)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_225">225</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;routed&nbsp;=&nbsp;reshard(routed,&nbsp;_batch_spec(get_abstract_mesh()))</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_226">226</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_227">227</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.shared_w_up_gate&nbsp;is&nbsp;None:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_228">228</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;self.shared_w_down&nbsp;is&nbsp;None</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_229">229</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;routed</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_230">230</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;self.shared_w_down&nbsp;is&nbsp;not&nbsp;None</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_231">231</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_232">232</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared_out&nbsp;=&nbsp;_shared_dense_mlp(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_233">233</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_234">234</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.shared_w_up_gate,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_235">235</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.shared_w_down,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_236">236</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activation=ActivationFunctionEnum.silu,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_237">237</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_238">238</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;routed&nbsp;+&nbsp;shared_out</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_239">239</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_240">240</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_129">129</td><td nowrap="nowrap">class&nbsp;Block(eqx.Module):</td><td class="diff_next"></td><td class="diff_header" id="to1_241">241</td><td nowrap="nowrap">class&nbsp;Block(eqx.Module):</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__13"></td><td class="diff_header" id="from1_130">130</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;rms_attn:&nbsp;RMSNorm</td><td class="diff_next"></td><td class="diff_header" id="to1_242">242</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;rms_attn:&nbsp;RMSNorm</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_131">131</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;attn:&nbsp;CausalSelfAttention</td><td class="diff_next"></td><td class="diff_header" id="to1_243">243</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;attn:&nbsp;CausalSelfAttention</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_132">132</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;rms_mlp:&nbsp;RMSNorm</td><td class="diff_next"></td><td class="diff_header" id="to1_244">244</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;rms_mlp:&nbsp;RMSNorm</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__14">n</a></td><td class="diff_header" id="from1_133">133</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;mlp:&nbsp;MLP</td><td class="diff_next"><a href="#difflib_chg_to1__14">n</a></td><td class="diff_header" id="to1_245">245</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;mlp:&nbsp;<span class="diff_add">MoE</span>MLP</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_134">134</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_246">246</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_135">135</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod</td><td class="diff_next"></td><td class="diff_header" id="to1_247">247</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@staticmethod</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_136">136</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;init(cfg:&nbsp;GrugModelConfig,&nbsp;*,&nbsp;key:&nbsp;PRNGKeyArray)&nbsp;-&gt;&nbsp;"Block":</td><td class="diff_next"></td><td class="diff_header" id="to1_248">248</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;init(cfg:&nbsp;GrugModelConfig,&nbsp;*,&nbsp;key:&nbsp;PRNGKeyArray)&nbsp;-&gt;&nbsp;"Block":</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__14"></td><td class="diff_header" id="from1_139">139</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rms_attn=RMSNorm.init(cfg.hidden_dim,&nbsp;cfg.layer_norm_eps),</td><td class="diff_next"></td><td class="diff_header" id="to1_251">251</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rms_attn=RMSNorm.init(cfg.hidden_dim,&nbsp;cfg.layer_norm_eps),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_140">140</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn=CausalSelfAttention.init(cfg,&nbsp;key=attn_key),</td><td class="diff_next"></td><td class="diff_header" id="to1_252">252</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attn=CausalSelfAttention.init(cfg,&nbsp;key=attn_key),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_141">141</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rms_mlp=RMSNorm.init(cfg.hidden_dim,&nbsp;cfg.layer_norm_eps),</td><td class="diff_next"></td><td class="diff_header" id="to1_253">253</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rms_mlp=RMSNorm.init(cfg.hidden_dim,&nbsp;cfg.layer_norm_eps),</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__15">n</a></td><td class="diff_header" id="from1_142">142</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mlp=MLP.init(cfg,&nbsp;key=mlp_key),</td><td class="diff_next"><a href="#difflib_chg_to1__15">n</a></td><td class="diff_header" id="to1_254">254</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mlp=<span class="diff_add">MoE</span>MLP.init(cfg,&nbsp;key=mlp_key),</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_143">143</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td><td class="diff_next"></td><td class="diff_header" id="to1_255">255</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_144">144</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_256">256</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_145">145</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@named_call</td><td class="diff_next"></td><td class="diff_header" id="to1_257">257</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;@named_call</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__15"></td><td class="diff_header" id="from1_163">163</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_proj&nbsp;=&nbsp;reshard(_init_weight(out_key,&nbsp;(cfg.hidden_dim,&nbsp;cfg.vocab_size),&nbsp;cfg.initializer_std),&nbsp;Pvocab)</td><td class="diff_next"></td><td class="diff_header" id="to1_275">275</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_proj&nbsp;=&nbsp;reshard(_init_weight(out_key,&nbsp;(cfg.hidden_dim,&nbsp;cfg.vocab_size),&nbsp;cfg.initializer_std),&nbsp;Pvocab)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_164">164</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blocks&nbsp;=&nbsp;tuple(Block.init(cfg,&nbsp;key=layer_key)&nbsp;for&nbsp;layer_key&nbsp;in&nbsp;block_keys)</td><td class="diff_next"></td><td class="diff_header" id="to1_276">276</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blocks&nbsp;=&nbsp;tuple(Block.init(cfg,&nbsp;key=layer_key)&nbsp;for&nbsp;layer_key&nbsp;in&nbsp;block_keys)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_165">165</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final_norm&nbsp;=&nbsp;RMSNorm.init(cfg.hidden_dim,&nbsp;cfg.layer_norm_eps)</td><td class="diff_next"></td><td class="diff_header" id="to1_277">277</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final_norm&nbsp;=&nbsp;RMSNorm.init(cfg.hidden_dim,&nbsp;cfg.layer_norm_eps)</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__16">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__16">n</a></td><td class="diff_header" id="to1_278">278</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_166">166</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Transformer(</td><td class="diff_next"></td><td class="diff_header" id="to1_279">279</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Transformer(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_167">167</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_embed=token_embed,</td><td class="diff_next"></td><td class="diff_header" id="to1_280">280</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_embed=token_embed,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_168">168</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_proj=output_proj,</td><td class="diff_next"></td><td class="diff_header" id="to1_281">281</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_proj=output_proj,</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__16"></td><td class="diff_header" id="from1_180">180</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mask&nbsp;is&nbsp;None:</td><td class="diff_next"></td><td class="diff_header" id="to1_293">293</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;mask&nbsp;is&nbsp;None:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_181">181</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask&nbsp;=&nbsp;AttentionMask.causal()</td><td class="diff_next"></td><td class="diff_header" id="to1_294">294</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask&nbsp;=&nbsp;AttentionMask.causal()</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_182">182</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_295">295</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__17">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__17">n</a></td><td class="diff_header" id="to1_296">296</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch_spec&nbsp;=&nbsp;_batch_spec(get_abstract_mesh())</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_183">183</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hidden&nbsp;=&nbsp;self.token_embed.at[token_ids].get(out_sharding=<span class="diff_sub">P</span>batch)</td><td class="diff_next"></td><td class="diff_header" id="to1_297">297</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hidden&nbsp;=&nbsp;self.token_embed.at[token_ids].get(out_sharding=batch<span class="diff_add">_spec</span>)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_184">184</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;block&nbsp;in&nbsp;self.blocks:</td><td class="diff_next"></td><td class="diff_header" id="to1_298">298</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;block&nbsp;in&nbsp;self.blocks:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_185">185</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hidden&nbsp;=&nbsp;eqx.filter_checkpoint(block)(hidden,&nbsp;mask)</td><td class="diff_next"></td><td class="diff_header" id="to1_299">299</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hidden&nbsp;=&nbsp;eqx.filter_checkpoint(block)(hidden,&nbsp;mask)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_186">186</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.final_norm(hidden)</td><td class="diff_next"></td><td class="diff_header" id="to1_300">300</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.final_norm(hidden)</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__17"></td><td class="diff_header" id="from1_191">191</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_ids:&nbsp;Int[Array,&nbsp;"B&nbsp;S"],</td><td class="diff_next"></td><td class="diff_header" id="to1_305">305</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_ids:&nbsp;Int[Array,&nbsp;"B&nbsp;S"],</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_192">192</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask:&nbsp;AttentionMask&nbsp;|&nbsp;jax.Array&nbsp;|&nbsp;None&nbsp;=&nbsp;None,</td><td class="diff_next"></td><td class="diff_header" id="to1_306">306</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask:&nbsp;AttentionMask&nbsp;|&nbsp;jax.Array&nbsp;|&nbsp;None&nbsp;=&nbsp;None,</td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__18"></td><td class="diff_header" id="from1_193">193</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;V"]:</td><td class="diff_next"></td><td class="diff_header" id="to1_307">307</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;-&gt;&nbsp;Float[Array,&nbsp;"B&nbsp;S&nbsp;V"]:</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__18">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__18">n</a></td><td class="diff_header" id="to1_308">308</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch_spec&nbsp;=&nbsp;_batch_spec(get_abstract_mesh())</span></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__19"></td><td class="diff_header" id="from1_194">194</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hidden&nbsp;=&nbsp;self(token_ids,&nbsp;mask=mask)</td><td class="diff_next"></td><td class="diff_header" id="to1_309">309</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hidden&nbsp;=&nbsp;self(token_ids,&nbsp;mask=mask)</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__19">n</a></td><td class="diff_header" id="from1_195">195</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;jnp.einsum("bsh,hd-&gt;bsd",&nbsp;hidden,&nbsp;self.output_proj,&nbsp;out_sharding=<span class="diff_sub">P</span>batch)</td><td class="diff_next"><a href="#difflib_chg_to1__19">n</a></td><td class="diff_header" id="to1_310">310</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;jnp.einsum("bsh,hd-&gt;bsd",&nbsp;hidden,&nbsp;self.output_proj,&nbsp;out_sharding=batch<span class="diff_add">_spec</span>)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_196">196</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_311">311</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__20">n</a></td><td class="diff_header" id="from1_197">197</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;<span class="diff_sub">compute_</span>next_token_loss(</td><td class="diff_next"><a href="#difflib_chg_to1__20">n</a></td><td class="diff_header" id="to1_312">312</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;next_token_loss(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_198">198</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,</td><td class="diff_next"></td><td class="diff_header" id="to1_313">313</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_199">199</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_ids:&nbsp;Int[Array,&nbsp;"B&nbsp;S"],</td><td class="diff_next"></td><td class="diff_header" id="to1_314">314</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_ids:&nbsp;Int[Array,&nbsp;"B&nbsp;S"],</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_200">200</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loss_weight:&nbsp;Float[Array,&nbsp;"B&nbsp;S"],</td><td class="diff_next"></td><td class="diff_header" id="to1_315">315</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loss_weight:&nbsp;Float[Array,&nbsp;"B&nbsp;S"],</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to1__20"></td><td class="diff_header" id="from1_224">224</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;std&nbsp;*&nbsp;random.truncated_normal(key,&nbsp;-3,&nbsp;3,&nbsp;shape)</td><td class="diff_next"></td><td class="diff_header" id="to1_339">339</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;std&nbsp;*&nbsp;random.truncated_normal(key,&nbsp;-3,&nbsp;3,&nbsp;shape)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_225">225</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_340">340</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_226">226</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_341">341</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__21">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__21">n</a></td><td class="diff_header" id="to1_342">342</td><td nowrap="nowrap"><span class="diff_add">def&nbsp;debug_mesh_and_token_pspec(num_devices:&nbsp;int)&nbsp;-&gt;&nbsp;tuple[jax.sharding.AbstractMesh,&nbsp;P]:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_343">343</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;"""Return&nbsp;a&nbsp;small&nbsp;abstract&nbsp;mesh&nbsp;and&nbsp;token&nbsp;sharding&nbsp;for&nbsp;lowering&nbsp;contract&nbsp;tests."""</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_344">344</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;num_devices&nbsp;&lt;=&nbsp;0:</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_345">345</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;ValueError(f"num_devices&nbsp;must&nbsp;be&nbsp;positive,&nbsp;got&nbsp;{num_devices}")</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_346">346</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Keep&nbsp;expert&nbsp;axis&nbsp;at&nbsp;2&nbsp;when&nbsp;possible&nbsp;to&nbsp;exercise&nbsp;EP&nbsp;lowering,&nbsp;otherwise</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_347">347</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;fall&nbsp;back&nbsp;to&nbsp;expert=1.</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_348">348</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;expert&nbsp;=&nbsp;2&nbsp;if&nbsp;num_devices&nbsp;%&nbsp;2&nbsp;==&nbsp;0&nbsp;else&nbsp;1</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_349">349</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;max(1,&nbsp;num_devices&nbsp;//&nbsp;expert)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_350">350</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;mesh&nbsp;=&nbsp;jax.sharding.AbstractMesh(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_351">351</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;axis_sizes=(data,&nbsp;expert,&nbsp;1),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_352">352</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;axis_names=("data",&nbsp;"expert",&nbsp;"model"),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_353">353</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;axis_types=(</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_354">354</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jax.sharding.AxisType.Explicit,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_355">355</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jax.sharding.AxisType.Explicit,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_356">356</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jax.sharding.AxisType.Explicit,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_357">357</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_358">358</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_359">359</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mesh,&nbsp;P(("data",&nbsp;"expert"),&nbsp;None)</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_360">360</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_361">361</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_362">362</td><td nowrap="nowrap"><span class="diff_add">GrugMoeModelConfig&nbsp;=&nbsp;GrugModelConfig</span></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__21"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_363">363</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_364">364</td><td nowrap="nowrap"><span class="diff_add">&nbsp;</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_227">227</td><td nowrap="nowrap">__all__&nbsp;=&nbsp;[</td><td class="diff_next"></td><td class="diff_header" id="to1_365">365</td><td nowrap="nowrap">__all__&nbsp;=&nbsp;[</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__22">n</a></td><td class="diff_header" id="from1_228">228</td><td nowrap="nowrap"><span class="diff_sub">&nbsp;&nbsp;&nbsp;&nbsp;"MLP",</span></td><td class="diff_next"><a href="#difflib_chg_to1__22">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__22"></td><td class="diff_header" id="from1_229">229</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"Block",</td><td class="diff_next"></td><td class="diff_header" id="to1_366">366</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"Block",</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_230">230</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"CausalSelfAttention",</td><td class="diff_next"></td><td class="diff_header" id="to1_367">367</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"CausalSelfAttention",</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_231">231</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"GrugModelConfig",</td><td class="diff_next"></td><td class="diff_header" id="to1_368">368</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"GrugModelConfig",</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__23">n</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__23">n</a></td><td class="diff_header" id="to1_369">369</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;"GrugMoeModelConfig",</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_370">370</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;"MoEMLP",</span></td></tr>
            <tr><td class="diff_next" id="difflib_chg_to1__23"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_371">371</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;"MoeActivation",</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_232">232</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"RMSNorm",</td><td class="diff_next"></td><td class="diff_header" id="to1_372">372</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"RMSNorm",</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_233">233</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"Transformer",</td><td class="diff_next"></td><td class="diff_header" id="to1_373">373</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;"Transformer",</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to1__top">t</a></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"><a href="#difflib_chg_to1__top">t</a></td><td class="diff_header" id="to1_374">374</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;"debug_mesh_and_token_pspec",</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to1_375">375</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;"moe_mlp",</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from1_234">234</td><td nowrap="nowrap">]</td><td class="diff_next"></td><td class="diff_header" id="to1_376">376</td><td nowrap="nowrap">]</td></tr>
        </tbody>
    </table><p><a href="#top">Back to top</a></p></section><section class="diff-section" id="file-3"><div class="diff-header"><h2>train.py</h2><span class="status changed">changed</span></div>
    <table class="diff" id="difflib_chg_to2__top"
           cellspacing="0" cellpadding="0" rules="groups" >
        <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
        <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
        <thead><tr><th class="diff_next"><br /></th><th colspan="2" class="diff_header">experiments/grug/base/train.py</th><th class="diff_next"><br /></th><th colspan="2" class="diff_header">experiments/grug/moe/train.py</th></tr></thead>
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to2__0"></td><td class="diff_header" id="from2_37">37</td><td nowrap="nowrap">from&nbsp;levanter.utils.jax_utils&nbsp;import&nbsp;parameter_count</td><td class="diff_next"></td><td class="diff_header" id="to2_37">37</td><td nowrap="nowrap">from&nbsp;levanter.utils.jax_utils&nbsp;import&nbsp;parameter_count</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_38">38</td><td nowrap="nowrap">from&nbsp;levanter.utils.logging&nbsp;import&nbsp;LoadingTimeTrackerIterator</td><td class="diff_next"></td><td class="diff_header" id="to2_38">38</td><td nowrap="nowrap">from&nbsp;levanter.utils.logging&nbsp;import&nbsp;LoadingTimeTrackerIterator</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_39">39</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_39">39</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to2__1">n</a></td><td class="diff_header" id="from2_40">40</td><td nowrap="nowrap">from&nbsp;experiments.grug.<span class="diff_chg">bas</span>e.model&nbsp;import&nbsp;GrugModelConfig,&nbsp;Transformer</td><td class="diff_next"><a href="#difflib_chg_to2__1">n</a></td><td class="diff_header" id="to2_40">40</td><td nowrap="nowrap">from&nbsp;experiments.grug.<span class="diff_chg">mo</span>e.model&nbsp;import&nbsp;GrugModelConfig,&nbsp;Transformer</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_41">41</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_41">41</td><td nowrap="nowrap"></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_42">42</td><td nowrap="nowrap">logger&nbsp;=&nbsp;logging.getLogger(__name__)</td><td class="diff_next"></td><td class="diff_header" id="to2_42">42</td><td nowrap="nowrap">logger&nbsp;=&nbsp;logging.getLogger(__name__)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_43">43</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_43">43</td><td nowrap="nowrap"></td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to2__1"></td><td class="diff_header" id="from2_148">148</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;eval_loss_fn(model:&nbsp;Transformer,&nbsp;batch:&nbsp;LmExample&nbsp;|&nbsp;GrugLmExample)&nbsp;-&gt;&nbsp;tuple[jax.Array,&nbsp;jax.Array,&nbsp;jax.Array]:</td><td class="diff_next"></td><td class="diff_header" id="to2_148">148</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;eval_loss_fn(model:&nbsp;Transformer,&nbsp;batch:&nbsp;LmExample&nbsp;|&nbsp;GrugLmExample)&nbsp;-&gt;&nbsp;tuple[jax.Array,&nbsp;jax.Array,&nbsp;jax.Array]:</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_149">149</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(batch,&nbsp;LmExample):</td><td class="diff_next"></td><td class="diff_header" id="to2_149">149</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;isinstance(batch,&nbsp;LmExample):</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_150">150</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch&nbsp;=&nbsp;grug_lm_example_from_named(batch)</td><td class="diff_next"></td><td class="diff_header" id="to2_150">150</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch&nbsp;=&nbsp;grug_lm_example_from_named(batch)</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to2__2">n</a></td><td class="diff_header" id="from2_151">151</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;per_pos_loss&nbsp;=&nbsp;model.<span class="diff_sub">compute_</span>next_token_loss(</td><td class="diff_next"><a href="#difflib_chg_to2__2">n</a></td><td class="diff_header" id="to2_151">151</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;per_pos_loss&nbsp;=&nbsp;model.next_token_loss(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_152">152</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.tokens,</td><td class="diff_next"></td><td class="diff_header" id="to2_152">152</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.tokens,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_153">153</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.loss_weight,</td><td class="diff_next"></td><td class="diff_header" id="to2_153">153</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.loss_weight,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_154">154</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask=batch.attn_mask,</td><td class="diff_next"></td><td class="diff_header" id="to2_154">154</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask=batch.attn_mask,</td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to2__2"></td><td class="diff_header" id="from2_183">183</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_heads=model_config.num_heads,</td><td class="diff_next"></td><td class="diff_header" id="to2_183">183</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_heads=model_config.num_heads,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_184">184</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seq_len=model_config.max_seq_len,</td><td class="diff_next"></td><td class="diff_header" id="to2_184">184</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seq_len=model_config.max_seq_len,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_185">185</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vocab_size=model_config.vocab_size,</td><td class="diff_next"></td><td class="diff_header" id="to2_185">185</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vocab_size=model_config.vocab_size,</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to2__3">n</a></td><td class="diff_header" id="from2_186">186</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glu=<span class="diff_chg">Fals</span>e,</td><td class="diff_next"><a href="#difflib_chg_to2__3">n</a></td><td class="diff_header" id="to2_186">186</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glu=<span class="diff_chg">Tru</span>e,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_187">187</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_experts=model_config.num_experts,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_188">188</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_shared_experts=1&nbsp;if&nbsp;model_config.shared_expert_intermediate_dim&nbsp;&gt;&nbsp;0&nbsp;else&nbsp;0,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header"></td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_189">189</td><td nowrap="nowrap"><span class="diff_add">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_experts_per_tok=model_config.num_experts_per_token,</span></td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_187">187</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;)</td><td class="diff_next"></td><td class="diff_header" id="to2_190">190</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_188">188</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;flops_per_example&nbsp;=&nbsp;3&nbsp;*&nbsp;flops_per_token&nbsp;*&nbsp;model_config.max_seq_len</td><td class="diff_next"></td><td class="diff_header" id="to2_191">191</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;flops_per_example&nbsp;=&nbsp;3&nbsp;*&nbsp;flops_per_token&nbsp;*&nbsp;model_config.max_seq_len</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_189">189</td><td nowrap="nowrap"></td><td class="diff_next"></td><td class="diff_header" id="to2_192">192</td><td nowrap="nowrap"></td></tr>
        </tbody>        
        <tbody>
            <tr><td class="diff_next" id="difflib_chg_to2__3"></td><td class="diff_header" id="from2_246">246</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;train_step(state:&nbsp;GrugTrainState,&nbsp;batch,&nbsp;*,&nbsp;compute_watch:&nbsp;bool&nbsp;=&nbsp;False):</td><td class="diff_next"></td><td class="diff_header" id="to2_249">249</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;train_step(state:&nbsp;GrugTrainState,&nbsp;batch,&nbsp;*,&nbsp;compute_watch:&nbsp;bool&nbsp;=&nbsp;False):</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_247">247</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;loss_fn(params):</td><td class="diff_next"></td><td class="diff_header" id="to2_250">250</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;loss_fn(params):</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_248">248</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compute_params&nbsp;=&nbsp;mp.cast_to_compute(params)</td><td class="diff_next"></td><td class="diff_header" id="to2_251">251</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compute_params&nbsp;=&nbsp;mp.cast_to_compute(params)</td></tr>
            <tr><td class="diff_next"><a href="#difflib_chg_to2__top">t</a></td><td class="diff_header" id="from2_249">249</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;compute_params.<span class="diff_sub">compute_</span>next_token_loss(</td><td class="diff_next"><a href="#difflib_chg_to2__top">t</a></td><td class="diff_header" id="to2_252">252</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;compute_params.next_token_loss(</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_250">250</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.tokens,</td><td class="diff_next"></td><td class="diff_header" id="to2_253">253</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.tokens,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_251">251</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.loss_weight,</td><td class="diff_next"></td><td class="diff_header" id="to2_254">254</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batch.loss_weight,</td></tr>
            <tr><td class="diff_next"></td><td class="diff_header" id="from2_252">252</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask=batch.attn_mask,</td><td class="diff_next"></td><td class="diff_header" id="to2_255">255</td><td nowrap="nowrap">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask=batch.attn_mask,</td></tr>
        </tbody>
    </table><p><a href="#top">Back to top</a></p></section>
    </main>
  </body>
</html>
