# vllm/vllm-tpu:9dbf7a2dc1448d6657adfb2daba36be270dcebcd - 0.7.4 has some issues
# FROM vllm/vllm-tpu:e92694b6fe264a85371317295bca6643508034ef
# FROM vllm/vllm-tpu:nightly
FROM anyscale/ray:2.46.0-slim-py312-cpu
ARG VLLM_VERSION=v0.9.0
USER root

# Setup gcsfuse
RUN apt-get update && apt-get install lsb-release rsync docker.io curl ca-certificates unzip gnupg -y
RUN usermod -aG docker $(whoami)

# Setup uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
RUN echo "export RAY_RUNTIME_ENV_HOOK=ray._private.runtime_env.uv_runtime_env_hook.hook" >> /home/ray/.bashrc

RUN export GCSFUSE_REPO=gcsfuse-`lsb_release -c -s` && echo "deb https://packages.cloud.google.com/apt $GCSFUSE_REPO main" | tee /etc/apt/sources.list.d/gcsfuse.list
RUN curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
RUN apt-get update && apt-get install fuse gcsfuse -y
RUN mkdir /opt/gcsfuse_mount
RUN chown -R $(whoami) /opt/gcsfuse_mount

# Install the Google Cloud SDK
RUN curl -sSL https://sdk.cloud.google.com > /tmp/gcl && \
    bash /tmp/gcl --install-dir=/root/gcloud --disable-prompts && \
    chown -R $(whoami) /root/gcloud

# Set the virtual environment used by uv, which is the conda environment that comes with ray
ENV CONDA_PREFIX=/home/ray/anaconda3
RUN sudo apt update && \
    sudo mkdir -p /opt/vllm && \
    sudo chown -R $(whoami) /opt/vllm && \
    cd /opt/vllm && \
    git clone https://github.com/vllm-project/vllm.git && \
    cd vllm && \
    git checkout ${VLLM_VERSION} && \
    uv pip uninstall torch torch-xla && \
    pip install --no-cache-dir -r requirements/tpu.txt && \
    sudo apt-get install libopenblas-base libopenmpi-dev libomp-dev -y && \
    VLLM_TARGET_DEVICE="tpu" python3 -m pip install -e .

# Add /usr/lib/x86_64-linux-gnu/ to LD_LIBRARY_PATH so that bash prefers the systems
# libtinfo.so over the conda-provided version. Using the conda-provided libtinfo.so
# outputs a noisy warning because it doesn't include version information.
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/x86_64-linux-gnu/
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/ray/anaconda3/lib
ENV PATH=$PATH:/root/gcloud/google-cloud-sdk/bin
ENV VLLM_USE_V1=1
ENV TF_CPP_MIN_LOG_LEVEL=1
ENV HF_HOME=/opt/gcsfuse_mount/huggingface-cache

WORKDIR /opt/marin
