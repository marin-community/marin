[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "marin-root"
version = "0.1.0"
description = "Marin workspace root and experiments"
license = { file = "LICENSE" }
requires-python = ">=3.11"
dependencies = ["marin", "levanter"]

[tool.uv.workspace]
members = ["lib/marin", "lib/levanter"]

[tool.uv.sources.marin]
workspace = true

[tool.uv.sources.levanter]
workspace = true

[tool.black]
line-length = 121
target-version = ["py310"]
preview = true

# Note :: Grow more strict over time!
extend-exclude = """
(
    scripts/
)
"""

[tool.ruff]
line-length = 121
target-version = "py310"

# Note :: Grow more strict over time!
extend-exclude = ["scripts/"]

[tool.ruff.lint]
select = ["A", "B", "E", "F", "I", "NPY", "RUF", "UP", "W"]
ignore = ["F722", "B008", "UP015", "A005", "I001"]

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["E402", "F401"]


[tool.mypy]
python_version = "3.10"

# Note: Grow more strict over time!
ignore_missing_imports = true
exclude = ["marin/", "scripts/"]

# Pyrefly type checker configuration
# Note: Grow more strict over time by enabling error codes!
[tool.pyrefly]
# Include main source directories for type checking
project-includes = ["lib/marin/src/**/*.py", "lib/levanter/src/**/*.py"]

# Exclude non-production code from type checking
project-excludes = [
    "experiments/**",
    "scripts/**",
    "tests/**",
    "**/snapshots/**",
    "**/__pycache__/**",
    "**/.pytest_cache/**",
    "**/build/**",
    "**/dist/**",
]

# Disable specific error codes that are primarily noise from missing type stubs
# These can be gradually enabled as the codebase improves
[tool.pyrefly.errors]
# Missing imports (824 occurrences) - third-party libs without stubs
missing-import = false

# Unexpected keyword arguments (47 occurrences) - dynamic configs from transformers, dataclasses
unexpected-keyword = false

# Missing attributes (315 occurrences) - often from untyped libraries like ray, jax, etc.
# These are mostly false positives from libraries without complete type stubs
missing-attribute = false

# Additional error types with >10 occurrences that are hard to fix systematically:

# Deprecated APIs (19 occurrences) - would require code changes across multiple files
deprecated = false

# Unknown name errors (17 occurrences) - often from dynamic code or missing stubs
unknown-name = false

# Not iterable errors (17 occurrences) - complex type inference issues with JAX/numpy
not-iterable = false

# No matching overload (16 occurrences) - complex overload resolution issues
no-matching-overload = false

# Bad index (12 occurrences) - complex dict/list type inference
bad-index = false

# Keep these enabled to catch real type errors that should be fixed over time:
# bad-argument-type = true (64 occurrences)
# bad-return = true (45 occurrences)
# unbound-name = true (63 occurrences)
# bad-assignment = true (31 occurrences)
# bad-override = true (37 occurrences)
# unsupported-operation = true (40 occurrences)
# not-callable = true (25 occurrences)

[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.build.targets.wheel]
packages = ["experiments"]

[tool.hatch.build.targets.sdist]
packages = ["experiments"]

[tool.pytest.ini_options]
timeout = 300
filterwarnings = ["ignore::DeprecationWarning"]
log_format = "%(asctime)s %(levelname)s %(message)s"
log_date_format = "%Y-%m-%d %H:%M:%S"
markers = [
    "slow: mark tests as slow for CI - use -m 'not slow'",
    "tpu_ci: mark tests that require a TPU",
]

# Make sure we timeout before CI kills us, and don't run TPU tests by default
addopts = "--session-timeout=500 --dist=worksteal -m 'not tpu_ci'"
