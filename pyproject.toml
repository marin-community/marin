[build-system]
requires = [
    "hatchling",
]
build-backend = "hatchling.build"
requires-python = ">=3.11,<3.13"

[project]
name = "marin"
version = "0.1.0"
readme = "README.md"
requires-python = ">=3.11"
dependencies = [
    "braceexpand==0.1.7",
    "cryptography==46.0.1",
    "datasets==4.1.1",
    "deepdiff==8.6.1",
    "draccus==0.11.5",
    "fasteners==0.20",
    "gcsfs==2025.9.0",
    "google-api-python-client==2.183.0",
    "google-cloud-storage==3.4.0",
    "google-cloud-storage-transfer==1.17.0",
    "jax==0.6.2",
    "haliax==1.4.dev413",
    "levanter[serve]@git+https://github.com/marin-community/levanter.git",
    "lz4==4.4.4",
    "multiprocess==0.70.16",
    "numpy==2.3.3",
    "openai==1.109.1",
    "pandas==2.3.2",
    "pyarrow==21.0.0",
    "ray==2.49.2",
    "regex==2025.9.18",
    "requests==2.32.5",
    "s3fs==2025.9.0",
    "sentencepiece==0.2.1",
    "toml==0.10.2",
    "torch==2.8.0",
    "tqdm==4.67.1",
    "tqdm-loggable==0.2",
    "wandb==0.22.0",
]

[project.license]
file = "LICENSE"

[project.optional-dependencies]
gcp = [
    "google-api-python-client==2.183.0",
    "cryptography==46.0.1",
    "google-cloud-storage==3.4.0",
    "google-cloud-storage-transfer==1.17.0",
    "google-cloud-compute",
]
cuda12 = [
    "jax[cuda12]==0.6.2",
    "torch==2.8.0",
]
tpu = [
    "jax[tpu]==0.6.2",
    "torch==2.8.0",
]
cpu = [
    "jax==0.6.2",
    "torch==2.8.0",
]
crawl = [
    "w3lib",
    "datatrove[io] @ git+https://github.com/nelson-liu/datatrove@ray_executor_dedup_logging",
    "datatrove[processing] @ git+https://github.com/nelson-liu/datatrove@ray_executor_dedup_logging",
    "beautifulsoup4==4.13.5",
    "resiliparse==0.15.2",
    "trafilatura==1.11.0",
    "warcio[all] @ git+https://github.com/nelson-liu/warcio@brotlicffi",
    "rbloom-gcs",
    "google-cloud-bigquery",
    "google-cloud-storage-transfer==1.17.0",
    "boto3",
    "readabilipy==0.3.0",
    "readability-lxml==0.8.4.1",
    "py7zr",
    "markdownify==1.2.0",
    "htmlmin",
    "datasets==4.1.1",
    "py-asciimath",
    "scipy==1.16.2",
    "spacy",
    "cupy-cuda12x",
    "transformers==4.55.4",
    "flax==0.11.0",
    "fastparquet",
    "orjson",
    "lxml[html_clean]==5.4.0",
    "lxml==5.4.0",
    "chardet==5.2.0",
    "courlan==1.3.2",
    "kenlm @ git+https://github.com/FredHaa/kenlm@fix-build-with-cmake-4.0",
    "jax[tpu]==0.6.2",
]
download_transform = [
    "chardet==5.2.0",
    "datasets==4.1.1",
    "fastparquet",
    "google-cloud-storage-transfer==1.17.0",
    "html2text",
    "htmlmin",
    "markdownify==1.2.0",
    "py7zr",
    "readabilipy==0.3.0",
    "readability-lxml==0.8.4.1",
    "lxml[html_clean]==5.4.0",
    "warcio==1.7.5",
    "resiliparse==0.15.2",
    "trafilatura==1.11.0",
    "boto3",
    "htmlmin",
]
quality_dedup_consolidate = [
    "fasttext",
    "huggingface_hub==0.35.1",
    "datasets==4.1.1",
    "transformers==4.55.4",
    "hyperloglog",
    "zstandard==0.25.0",
    "nltk",
    "cattrs",
    "fsspec==2025.9.0",
    "dolma @ git+https://github.com/marin-community/dolma",
]
tokenize_train = [
    "multiprocess==0.70.16",
    "haliax==1.4.dev413",
    "lm-eval@git+https://github.com/stanford-crfm/lm-evaluation-harness.git",
    "tblib==3.1.0",
    "sentencepiece==0.2.1",
    "tiktoken",
]
post_training = [
    "gcsfs==2025.9.0",
    "transformers==4.55.4",
    "flax==0.11.0",
    "jaxtyping==0.3.2",
    "tyro",
    "tqdm==4.67.1",
    "wandb==0.22.0",
    "einops",
    "ringattention",
    "sympy==1.14.0",
    "pylatexenc==2.10",
    "ipython",
    "datasets==4.1.1",
    "scalax@git+https://github.com/Sea-Snell/scalax.git",
    "swebench ; sys_platform != 'darwin'",
    "verifiers",
]
data_browser = [
    "zstandard==0.25.0",
]
eval = [
    "lm-eval@git+https://github.com/stanford-crfm/lm-evaluation-harness.git",
]

[dependency-groups]
test = [
    "pytest==8.4.2",
    "pytest-asyncio==1.2.0",
    "pytest-xdist==3.8.0",
    "pytest-timeout==2.4.0",
    "pytest-cov==7.0.0",
    "pytest-profiling==1.8.1",
    "pip==25.2",
    "openai-responses==0.12.0",
]
lint = [
    "ruff==0.13.2",
    "black==25.9.0",
    "pre-commit==4.3.0",
    "mypy==1.18.2",
    "types-PyYAML==6.0.12.20250915",
    "types-requests==2.32.4.20250913",
    "types-six==1.17.0.20250515",
]
docs = [
    "mkdocs==1.6.1",
    "mkdocs-material==9.6.20",
    "mkdocstrings==0.30.1",
    "mkdocstrings-python==1.18.2",
    "pymdown-extensions==10.16.1",
    "mkdocs-git-revision-date-localized-plugin==1.4.7",
    "mkdocs-git-authors-plugin==0.10.0",
    "mkdocs-minify-plugin==0.8.0",
    "mkdocs-include-markdown-plugin==7.1.8",
]
math = [
    "pylatexenc==2.10",
    "sympy==1.14.0",
]
metrics = [
    "google-cloud-logging",
]
transform_test_deps = [
    "trafilatura==1.11.0",
    "readabilipy==0.3.0",
    "readability-lxml==0.8.4.1",
    "warcio==1.7.5",
    "markdownify==1.2.0",
    "resiliparse==0.15.2",
]
dev = [
    { include-group = "test" },
    { include-group = "lint" },
    { include-group = "docs" },
    { include-group = "math" },
    { include-group = "transform_test_deps" },
]

[tool.uv]
conflicts = [
    [
        { extra = "crawl" },
        { extra = "post-training" },
    ],
    [
        { extra = "crawl" },
        { extra = "download-transform" },
    ],
    [
        { extra = "crawl" },
        { group = "transform-test-deps" },
    ],
    [
        { extra = "crawl" },
        { group = "dev" },
    ],
    [
        { extra = "tpu" },
        { extra = "cuda12" },
    ],
    [
        { extra = "cuda12" },
        { extra = "cpu" },
    ],
    [
        { extra = "tpu" },
        { extra = "cpu" },
    ],
]
index = [
    { name = "pytorch-cpu", url = "https://download.pytorch.org/whl/cpu", explicit = true },
    { name = "pytorch-cu128", url = "https://download.pytorch.org/whl/cu128", explicit = true },
]

[tool.uv.sources]
torch = [
    { index = "pytorch-cpu", extra = "cpu" },
    { index = "pytorch-cpu", extra = "tpu" },
    { index = "pytorch-cu128", extra = "cuda12" },
]

[tool.black]
line-length = 121
target-version = [
    "py310",
]
preview = true
extend-exclude = "(\n    scripts/\n)\n"

[tool.ruff]
line-length = 121
target-version = "py310"
extend-exclude = [
    "scripts/",
]

[tool.ruff.lint]
select = [
    "A",
    "B",
    "E",
    "F",
    "I",
    "NPY",
    "RUF",
    "UP",
    "W",
]
ignore = [
    "F722",
    "B008",
    "UP015",
    "A005",
    "I001",
]

[tool.ruff.lint.per-file-ignores]
"__init__.py" = [
    "E402",
    "F401",
]

[tool.mypy]
python_version = "3.10"
ignore_missing_imports = true
exclude = [
    "marin/",
    "scripts/",
]

[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.build.targets.wheel]
packages = [
    "src/marin",
    "experiments",
]

[tool.hatch.build.targets.sdist]
packages = [
    "src/marin",
    "experiments",
]

[tool.pytest.ini_options]
timeout = 300
session-timeout = 500
filterwarnings = [
    "ignore::DeprecationWarning",
]
log_format = "%(asctime)s %(levelname)s %(message)s"
log_date_format = "%Y-%m-%d %H:%M:%S"
log_cli_level = "INFO"
markers = [
    "slow: mark tests as slow for CI - use -m 'not slow'",
]
dist = "worksteal"
