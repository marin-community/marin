#!/usr/bin/env -S uv run
# /// script
# dependencies = ["PyGithub>=2.3.0", "openai"]
# ///
# Copyright 2025 The Marin Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""
This script:
- Reads all the GitHub issues with the `experiment` label.
- Prompts a language model to generate a summary.
- Writes the summary to `docs/reports/summary.md`.

Usage:
    ./scripts/generate_experiment_summary.py
"""

import os

from github import Github
from openai import OpenAI

MODEL = "gpt-4o"
PROMPT_PATH = "docs/reports/summary_prompt.txt"
OUTPUT_PATH = "docs/reports/summary.md"


def get_github_issues():
    """Get all issues with the `experiment` label."""
    g = Github()
    repo = g.get_repo("marin-community/marin")
    return repo.get_issues(labels=["experiment"], state="all")


def convert_issue_to_xml(issue):
    return f"""<issue>
        <number>{issue.number}</number>
        <title>{issue.title}</title>
        <state>{issue.state}</state>
        <created_at>{issue.created_at}</created_at>
        <updated_at>{issue.updated_at}</updated_at>
        <labels>{','.join([label.name for label in issue.labels])}</labels>
        <url>{issue.html_url}</url>
        <body>\n{issue.body}</body>
        <comments>{issue.comments}</comments>
    </issue>\n"""


prompt_template = """
You are a helpful assistant that summarizes GitHub issues.

Given the following issues:
<issues>
{issues}
</issues>

Please generate a report describing the issues.  Please keep the following in mind:
- Put a warning at the top that the report is generated by a language model and should not be trusted.
- The report should be in markdown format.
- The report should link to each of the issues (e.g., `[#123](https://github.com/marin-community/marin/issues/123)`).
- The report should contain the following sections:
  1. Overview: create a subsection for each topic and put all the issues for that topic in that subsection.
     Summarize the findings for each topic.  An issue might belong to more than one topic.
  2. Timeline: create a subsection for each month of the year (sorted in chronological order), and list all the issues that were **closed** during that month.
     Create a final subsection corresponding to open issues.
     Important: **all** issues must be included in the timeline, and each issue should appear exactly once.
"""


def main():
    print("Getting GitHub issues...")
    issues = list(get_github_issues())
    print(f"Read {len(issues)} issues.")
    xml = "\n".join([convert_issue_to_xml(issue) for issue in issues])

    print(f"Saving the prompt ({len(prompt_template)} characters) to {PROMPT_PATH}...")
    prompt = prompt_template.format(issues=xml)
    with open(PROMPT_PATH, "w") as f:
        f.write(prompt)

    print("Asking an LM to summarize..")
    client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
    response = client.chat.completions.create(
        model=MODEL,
        messages=[{"role": "user", "content": prompt}],
    )
    summary = response.choices[0].message.content

    # Write the summary to a file
    print(f"Writing summary ({len(summary)} characters) to {OUTPUT_PATH}...")
    with open(OUTPUT_PATH, "w") as f:
        f.write(summary)


if __name__ == "__main__":
    main()
